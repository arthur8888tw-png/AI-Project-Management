# CPDM 工時估算邏輯技術說明文件 (v2.0)

本文件詳細說明 AI 專案管理儀表板如何從「人類與 AI 的互動歷史」中，精確還原出真實的開發工時。本演算法旨在平衡「物理在席時間」與「實際腦力產出」，並特別針對高強度 AI 協作模式進行了優化。

---

## 1. 基礎數據來源
系統掃描 `conversations` 與對應的 `brain` 資料夾，獲取以下核心原始數據：
- **brainBirthtime (起)**：該對話第一個檔案（通常是 `task.md`）的建立時間。
- **brainMtime (訖)**：該對話最後一個變動檔案（包含程式碼生成或圖片上傳）的修改時間。
- **rawSpanHours (物理跨度)**：`訖 - 起` 的總小時數。
- **iterationCount (互動強度)**：統計對話目錄下產生的 `.resolved`、`.backup`、`uploaded_image` 及 `session_` 檔案總數。

---

## 2. 核心工時估算演算法
估算邏輯分為「實作工時」與「間隔校正」兩個階段：

### 階段 A：實作工時計算 (Active Hours)
1. **任務分類判定**：根據內容自動判定為 `開發模式`、`架構變更`、`資料處理` 或 `Debug`。
2. **會話封頂 (Capping)**：
   - **重型任務 (Heavy Task)**：上限 **6.0 小時**。
   - **一般任務 (Light Task)**：上限 **1.2 小時**。
3. **物理採信係數**：採信 `rawSpanHours * 1.05`。在此模型中，我們完全承認 AI 運算期間人類的監控等待時間（包含微小間隙的補償）。
4. **迭代補償 (Iteration Bonus)**：
   - 只要互動次數 > 1，即啟動補償。
   - **加權公式**：`iterationCount * 25 分鐘 (0.42h)`。
   - 這反映了每一次圖片上傳或程式碼修正背後的閱讀、截圖、發想與校對成本。
5. **最終實作工時**：取 `封頂值`、`物理採信值` 與 `迭代補償` 的平衡點，但絕對不超過物理限制。

### 階段 B：間隔校正 (Research & Thinking Gap)
為了還原兩次對話之間的「思考與研究時間」：
1. **Thinking Gap**：計算「上一筆對話結束」到「本筆對話開始」的空檔。
2. **研究時間歸屬 (Research Hours)**：
   - 若空檔在合理範圍內 (60-120 分鐘)，系統將其視為「離線研究」或「準備輔助資料」的時間。
   - 根據任務重量給予 **15 - 60 分鐘** 的自動工時補償，並加入該對話的總工時。

---

## 3. 物理一致性檢核 (Consistency Check)
為確保數據不虛報，系統應用了以下天花板限制：
- **物理時長限制**：單一對話的估算工時 `hours` 絕對不會大於其物理跨度 `rawSpanHours`。
- **時間軸去重**：若兩筆對話時間發生物理重疊，系統會將第二筆的「開始時間」強制接續在第一筆的「結束時間」之後，並依據剩餘的物理空間壓縮工時，確保總工時不會因為重疊而加倍計算。

---

## 4. 人機協作比例參考
根據 12/17 ~ 12/25 的大規模數據檢核，本演算法產出的比例大致如下：
- **物理在席 (含 AI 運算)**：100% (約 116h)
- **有效人類工時 (本系統紀錄)**：**~65% (約 78h)**
- **純休息/完全離開**：**~35% (約 38h)**

*註：AI 的純運算生成時間（約佔總體 10%）在本系統中已被視為人類監控工時的一環予以認可。*

---

## 5. 常見問答
**Q: 為什麼對話視窗開了一整天，工時卻沒有 24 小時？**  
A: 系統會偵測「無動作空隙」。若長時間（超過 2 小時）沒有任何檔案變動或圖片上傳，演算法會判定該時段為休息，並執行封頂保護。

**Q: 跨日任務如何顯示？**  
A: 系統採用「雙軌並行」邏輯：
1. **任務檢視 (Task-based)**：在「開發循環」與「詳細記錄」中，任務保持完整性，顯示單一區間與總工時。
2. **統計檢視 (Date-based)**：在「人員每日工時」中，系統會自動按物理比例將長任務拆分至各個日期，確保每日時數統計的物理真實性。

---

## 6. 工時展現邏輯：任務 vs. 日期拆分

為了兼顧「專案管理 (追蹤任務成果)」與「行政管理 (統計每日產出)」，系統實作了以下轉換邏輯：

### 6.1 任務單點邏輯 (Task Unit)
- **定義**：一次完整的 AI 對話視為一個「任務單元」。
- **特性**：包含完整的摘要、產出 (Artifacts) 與解決方案。
- **應用場景**：專案歷程記錄、效率評估 (LV 成長)、技術債分析。

### 6.2 日期比例拆分邏輯 (Date Splitting)
- **觸發條件**：當任務的 `modifiedTime` (訖) 與 `createdTime` (起) 跨越午夜 00:00 時。
- **計算方法**：
  1. 計算任務的總物理時長 $T_{total\_span}$。
  2. 識別任務跨越的每個自然日 $D_i$。
  3. 計算任務在 $D_i$ 當天的物理停留時間 $T_i$。
  4. 比例分配：該日分配工時 $H_i = \text{任務總工時} \times (T_i / T_{total\_span})$。
- **應用場景**：人員每日工時統計表、月度報表匯出、資源負載平衡。
- **物理校驗**：拆分後的各日工時加總，保證精確等於該任務的總工時。

---
**文件維護：Antigravity AI Assistant**
**最後更新日期：2025-12-26**
