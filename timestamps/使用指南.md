# 時間戳記工時追蹤系統使用指南

## 快速開始

### 1. 自動記錄時間戳記

時間戳記系統會在以下時機自動記錄:

- **使用者提問時**: 當您向 AI 提出問題時
- **AI 完成作業時**: 當 AI 完成所有工具呼叫並回應時

> **注意**: 目前需要手動呼叫 `timestamp_tracker.js` 來記錄時間戳記。未來版本將整合到 Antigravity 系統中實現自動記錄。

### 2. 手動記錄時間戳記

如果需要手動記錄時間戳記,可以使用以下方式:

```javascript
const tracker = require('./timestamp_tracker');

// 記錄使用者提問
tracker.recordUserQuestion(
  '336b26f3-3f2a-4fad-beb5-0a8bda46a425',  // 對話 ID
  '我查看交互歷史紀錄發現交談並沒有時間戳記...'  // 問題內容
);

// 記錄 AI 完成
tracker.recordAICompletion(
  '336b26f3-3f2a-4fad-beb5-0a8bda46a425',  // 對話 ID
  '完成時間戳記追蹤系統實作',  // 任務摘要
  7,  // 複雜度 (1-10)
  ['timestamp_tracker.js', 'auto_approval_config.json']  // 修改的檔案
);
```

### 3. 查看工時統計

#### 方法 A: 使用命令列工具

```bash
# 計算特定對話的工時
node timestamp_tracker.js calculate 336b26f3-3f2a-4fad-beb5-0a8bda46a425

# 匯出所有對話的工時統計
node timestamp_tracker.js export timestamp_hours_summary.json
```

#### 方法 B: 整合到專案報告

```bash
# 產生包含時間戳記數據的專案報告
node generate_interaction_history.js --format=json --output=project_interaction_history_auto.json
```

產生的 JSON 檔案會包含以下額外欄位:
- `timestampHours`: 基於時間戳記計算的工時
- `timestampInteractions`: 互動次數
- `hasTimestampData`: 是否有時間戳記數據

### 4. 在儀表板中查看

1. 開啟 `ProjectDashboard.html`
2. 匯入包含時間戳記數據的 JSON 檔案
3. 在「詳細記錄」頁籤中可以看到:
   - **檔案推算工時**: 基於 brain 檔案時間戳記
   - **時間戳記工時**: 基於精確的互動時間戳記
   - **互動次數**: 實際的提問-完成循環次數

## 自動放行配置

### 查看當前配置

配置檔案位於: `auto_approval_config.json`

### 測試自動放行邏輯

```bash
node auto_approval_handler.js test
```

### 查看決策統計

```bash
node auto_approval_handler.js stats
```

### 自訂配置

編輯 `auto_approval_config.json`:

```json
{
  "requireApproval": {
    "artifacts": ["implementation_plan.md", "task.md"],
    "operations": ["create_plan", "update_plan"]
  },
  "autoApprove": {
    "operations": ["code_edit", "test_execution", "documentation"],
    "filePatterns": ["**/*.js", "**/*.html", "**/*.css"]
  }
}
```

## 工時審計流程

### 1. 產生完整報告

```bash
# 產生包含時間戳記數據的完整報告
node generate_interaction_history.js --format=json --output=audit_report.json
```

### 2. 驗證工時準確性

在報告中對比以下數據:
- `hours`: 檔案推算工時 (基於 CPDM 演算法)
- `timestampHours`: 時間戳記工時 (基於實際互動時間)

**正常情況**: 兩者應該接近,差異在 ±20% 以內

**異常情況**:
- 如果 `timestampHours` 明顯小於 `hours`: 可能有長時間的 AI 運算或等待
- 如果 `timestampHours` 明顯大於 `hours`: 可能有跨日對話或長時間思考

### 3. 匯出審計證據

時間戳記檔案位於 `timestamps/{conversation-id}/` 目錄下,每個檔案都是獨立的證據:

```
timestamps/
└── 336b26f3-3f2a-4fad-beb5-0a8bda46a425/
    ├── user_question_2025-12-30T21-19-47+08-00_evt_1735564787_abc123.json
    ├── ai_completion_2025-12-30T21-21-29+08-00_evt_1735564889_def456.json
    └── ...
```

這些檔案可以:
- 提交到 Git 作為歷史記錄
- 匯出給審計人員檢查
- 用於工時爭議的證明

## 常見問題

### Q: 為什麼有些對話沒有時間戳記數據?

A: 時間戳記系統是新增功能,只會記錄啟用後的對話。舊的對話仍然使用檔案時間戳記估算。

### Q: 時間戳記工時和檔案推算工時差異很大怎麼辦?

A: 這是正常的。時間戳記記錄的是「純互動時間」,而檔案推算包含了「思考時間」和「研究時間」。建議以時間戳記為主,檔案推算為輔。

### Q: 可以手動編輯時間戳記檔案嗎?

A: 技術上可以,但強烈不建議。時間戳記的目的是提供客觀、不可篡改的工時證明。如需調整,應該在 `conversation_metadata.json` 中手動設定工時。

### Q: 如何確保時間戳記不會遺失?

A: 
1. 將 `timestamps/` 目錄加入 Git 追蹤
2. 定期備份專案目錄
3. 使用 `node timestamp_tracker.js export` 定期匯出摘要

### Q: 自動放行配置會影響時間戳記記錄嗎?

A: 不會。自動放行只是減少需要使用者確認的步驟,不影響時間戳記的記錄。無論是否自動放行,時間戳記都會正常記錄。

## 進階功能

### 整合到 CI/CD

可以在 CI/CD 流程中自動產生工時報告:

```yaml
# .github/workflows/work-hours-report.yml
name: Generate Work Hours Report
on:
  schedule:
    - cron: '0 0 * * 0'  # 每週日午夜
jobs:
  report:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Generate Report
        run: |
          node generate_interaction_history.js --format=json --output=weekly_report.json
          node timestamp_tracker.js export weekly_timestamp_summary.json
      - name: Upload Artifacts
        uses: actions/upload-artifact@v2
        with:
          name: weekly-reports
          path: |
            weekly_report.json
            weekly_timestamp_summary.json
```

### 自訂工時計算邏輯

如果需要自訂工時計算邏輯,可以修改 `timestamp_tracker.js` 中的 `calculateInteractionHours` 函數。

例如,調整「合理思考時間」的上限:

```javascript
// 原本: 只計算 < 2 小時的思考時間
if (thinkingTime > 0 && thinkingTime < 2) {
    userThinkingHours += thinkingTime;
}

// 調整為: 計算 < 4 小時的思考時間
if (thinkingTime > 0 && thinkingTime < 4) {
    userThinkingHours += thinkingTime;
}
```

---

**文件維護**: Antigravity AI Assistant  
**最後更新**: 2025-12-30  
**版本**: 1.0.0
