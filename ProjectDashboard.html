<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CPDM å°ˆæ¡ˆå·¥æ™‚çµ±è¨ˆå„€è¡¨æ¿ - æ•´åˆç‰ˆ</title>

    <!-- CDN Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Theme Variables */
        :root {
            --app-bg: #f1f5f9;
            --app-bg-stop1: #f1f5f9;
            --app-bg-stop2: #e2e8f0;
            --panel-bg: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border-color: #e2e8f0;
            --input-bg: #f8fafc;
            --card-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        }

        [data-theme="slate"] {
            --app-bg: #1e293b;
            --app-bg-stop1: #1e293b;
            --app-bg-stop2: #0f172a;
            --panel-bg: #334155;
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --border-color: #475569;
            --input-bg: #1e293b;
            --card-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.2), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        [data-theme="dark"] {
            --app-bg: #020617;
            --app-bg-stop1: #020617;
            --app-bg-stop2: #000000;
            --panel-bg: #0f172a;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --border-color: #1e293b;
            --input-bg: #020617;
            --card-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.3), 0 4px 6px -4px rgb(0 0 0 / 0.2);
        }

        /* Base Element Theme Overrides */
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to bottom right, var(--app-bg-stop1), var(--app-bg-stop2)) fixed !important;
            background-color: var(--app-bg) !important;
            color: var(--text-main);
            transition: all 0.3s ease;
            min-height: 100vh;
        }

        /* Component Overrides based on theme */
        [data-theme="dark"] nav,
        [data-theme="slate"] nav,
        [data-theme="dark"] .bg-white,
        [data-theme="slate"] .bg-white {
            background-color: var(--panel-bg) !important;
        }

        [data-theme="dark"] .bg-slate-50,
        [data-theme="slate"] .bg-slate-50 {
            background-color: var(--input-bg) !important;
        }

        [data-theme="dark"] .border-slate-200,
        [data-theme="slate"] .border-slate-200,
        [data-theme="dark"] .border-slate-100,
        [data-theme="slate"] .border-slate-100,
        [data-theme="dark"] .ring-slate-200,
        [data-theme="slate"] .ring-slate-200 {
            border-color: var(--border-color) !important;
            --tw-ring-color: var(--border-color) !important;
        }

        [data-theme="dark"] .bg-slate-100,
        [data-theme="slate"] .bg-slate-100 {
            background-color: var(--input-bg) !important;
        }

        [data-theme="dark"] .text-slate-800,
        [data-theme="slate"] .text-slate-800,
        [data-theme="dark"] .text-slate-700,
        [data-theme="slate"] .text-slate-700,
        [data-theme="dark"] .text-slate-600,
        [data-theme="slate"] .text-slate-600 {
            color: var(--text-main) !important;
        }

        [data-theme="dark"] .text-slate-500,
        [data-theme="slate"] .text-slate-500,
        [data-theme="dark"] .text-slate-400,
        [data-theme="slate"] .text-slate-400 {
            color: var(--text-muted) !important;
        }

        /* Table & Sticky Header Theme Fix */
        [data-theme="dark"] thead.bg-slate-50,
        [data-theme="slate"] thead.bg-slate-50,
        [data-theme="dark"] .sticky.top-0,
        [data-theme="slate"] .sticky.top-0 {
            background-color: var(--panel-bg) !important;
            color: var(--text-muted) !important;
        }

        [data-theme="dark"] tr:hover,
        [data-theme="slate"] tr:hover {
            background-color: rgba(255, 255, 255, 0.05) !important;
        }

        [data-theme="dark"] .divide-slate-100>*+* {
            border-color: var(--border-color) !important;
        }

        .tab-active {
            border-bottom: 2px solid #3b82f6;
            color: #3b82f6 !important;
        }

        .code-block {
            font-family: 'Fira Code', 'Consolas', monospace;
            border: 1px solid var(--border-color);
        }

        /* Custom Scrollbar Theme */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--app-bg);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--text-muted);
            border-radius: 4px;
            opacity: 0.3;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-main);
        }

        /* Dynamic transition */
        .bg-white,
        .bg-slate-50,
        body,
        nav,
        section,
        div,
        pre {
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }

        [data-theme="dark"] .dark-theme-badge,
        [data-theme="slate"] .dark-theme-badge {
            background-color: var(--border-color) !important;
            color: var(--text-main) !important;
            border-color: var(--border-color) !important;
        }

        [data-theme="dark"] .stats-col-total,
        [data-theme="slate"] .stats-col-total {
            background-color: rgba(255, 255, 255, 0.05) !important;
            color: var(--text-main) !important;
        }

        /* Fix specific Tailwind opacity backgrounds for Dark mode */
        [data-theme="dark"] .bg-slate-50\/50,
        [data-theme="slate"] .bg-slate-50\/50 {
            background-color: rgba(255, 255, 255, 0.03) !important;
        }

        [data-theme="dark"] .bg-indigo-100\/50,
        [data-theme="slate"] .bg-indigo-100\/50 {
            background-color: rgba(99, 102, 241, 0.2) !important;
            color: #a5b4fc !important;
        }

        [data-theme="dark"] .bg-blue-50\/50,
        [data-theme="slate"] .bg-blue-50\/50 {
            background-color: rgba(59, 130, 246, 0.1) !important;
        }

        [data-theme="dark"] .bg-blue-50,
        [data-theme="slate"] .bg-blue-50 {
            background-color: rgba(59, 130, 246, 0.1) !important;
            color: #60a5fa !important;
        }

        [data-theme="dark"] .bg-emerald-50,
        [data-theme="slate"] .bg-emerald-50 {
            background-color: rgba(16, 185, 129, 0.1) !important;
            color: #34d399 !important;
        }

        [data-theme="dark"] .bg-indigo-50,
        [data-theme="slate"] .bg-indigo-50 {
            background-color: rgba(99, 102, 241, 0.1) !important;
            color: #a5b4fc !important;
        }

        [data-theme="dark"] .bg-amber-50,
        [data-theme="slate"] .bg-amber-50 {
            background-color: rgba(245, 158, 11, 0.1) !important;
            color: #fbbf24 !important;
        }

        /* Instruction Panel Theme Overrides */
        [data-theme="dark"] .from-amber-50,
        [data-theme="slate"] .from-amber-50 {
            --tw-gradient-from: var(--panel-bg) !important;
        }

        [data-theme="dark"] .to-orange-50,
        [data-theme="slate"] .to-orange-50 {
            --tw-gradient-to: var(--panel-bg) !important;
        }

        [data-theme="dark"] .border-amber-200,
        [data-theme="slate"] .border-amber-200 {
            border-color: var(--border-color) !important;
        }

        [data-theme="dark"] .text-amber-700,
        [data-theme="slate"] .text-amber-700 {
            color: #fbbf24 !important;
        }

        [data-theme="dark"] .text-amber-600,
        [data-theme="slate"] .text-amber-600 {
            color: #f59e0b !important;
        }

        [data-theme="dark"] .text-indigo-700,
        [data-theme="slate"] .text-indigo-700 {
            color: #818cf8 !important;
        }

        [data-theme="dark"] .border-amber-100,
        [data-theme="slate"] .border-amber-100 {
            border-color: var(--border-color) !important;
        }

        /* Custom accent classes for instruction panel */
        .accent-amber {
            color: #f59e0b;
        }

        .accent-amber-hover:hover {
            color: #d97706;
        }

        .accent-indigo {
            color: #6366f1;
        }

        .accent-indigo-hover:hover {
            color: #4f46e5;
        }

        .accent-indigo-border {
            border-color: #e0e7ff;
        }

        [data-theme="dark"] .accent-amber,
        [data-theme="slate"] .accent-amber {
            color: #fbbf24 !important;
        }

        [data-theme="dark"] .accent-amber-hover:hover,
        [data-theme="slate"] .accent-amber-hover:hover {
            color: #fcd34d !important;
        }

        [data-theme="dark"] .accent-indigo,
        [data-theme="slate"] .accent-indigo {
            color: #818cf8 !important;
        }

        [data-theme="dark"] .accent-indigo-hover:hover,
        [data-theme="slate"] .accent-indigo-hover:hover {
            color: #a5b4fc !important;
        }

        [data-theme="dark"] .accent-indigo-border,
        [data-theme="slate"] .accent-indigo-border {
            border-color: var(--border-color) !important;
        }
    </style>
</head>

<body class="text-slate-800">

    <!-- Dynamic Fixed Header Container -->
    <div class="sticky top-0 z-50 shadow-sm">
        <nav class="bg-white border-b border-slate-200">
            <div class="max-w-7xl mx-auto px-6">
                <div class="flex justify-between h-16 items-center">
                    <div class="flex items-center gap-3">
                        <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-2.5 rounded-xl">
                            <i class="fa-solid fa-chart-pie text-xl"></i>
                        </div>
                        <div>
                            <div class="flex items-baseline gap-2">
                                <h1
                                    class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-indigo-600">
                                    CPDM å·¥æ™‚çµ±è¨ˆå„€è¡¨æ¿
                                </h1>
                                <span class="text-[10px] font-bold text-slate-400 opacity-60 select-none">v2.0</span>
                            </div>
                            <p class="text-xs text-slate-500">Antigravity å°è©±è¨˜éŒ„åˆ†æ Â· æ•´åˆç‰ˆ</p>
                        </div>
                    </div>
                    <!-- Right Side Combined Controls -->
                    <div class="flex items-center gap-1 bg-slate-100 p-1 rounded-xl border border-slate-200 shadow-sm">
                        <!-- Theme Selector -->
                        <div class="flex items-center gap-1">
                            <button onclick="setTheme('light')" id="theme-btn-light"
                                class="w-8 h-8 rounded-lg flex items-center justify-center transition-all hover:bg-white"
                                title="äº®è‰²æ¨¡å¼">
                                <i class="fa-solid fa-sun text-sm text-amber-500"></i>
                            </button>
                            <button onclick="setTheme('slate')" id="theme-btn-slate"
                                class="w-8 h-8 rounded-lg flex items-center justify-center transition-all hover:bg-slate-700 hover:text-white"
                                title="ä¸­è‰²æ¨¡å¼ (Slate)">
                                <i class="fa-solid fa-cloud-moon text-sm text-slate-500"></i>
                            </button>
                            <button onclick="setTheme('dark')" id="theme-btn-dark"
                                class="w-8 h-8 rounded-lg flex items-center justify-center transition-all hover:bg-slate-900 hover:text-white"
                                title="æ·±è‰²æ¨¡å¼">
                                <i class="fa-solid fa-moon text-sm text-indigo-400"></i>
                            </button>
                        </div>

                        <div class="h-6 w-[1px] bg-slate-200 mx-1"></div>

                        <!-- Font Size Controller -->
                        <div class="flex items-center gap-3 px-2 py-0.5">
                            <span class="text-[10px] font-bold text-slate-400 select-none">A</span>
                            <input type="range" id="fontSizeSlider" min="12" max="22" value="16" step="1"
                                class="w-24 h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600"
                                oninput="updateFontSize(this.value)" title="èª¿æ•´å…¨ç«™å­—é«”å¤§å°">
                            <span class="text-sm font-bold text-slate-400 select-none">A</span>
                            <div class="h-4 w-[1px] bg-slate-200 mx-1"></div>
                            <span id="fontSizeValue"
                                class="text-[10px] font-mono font-bold text-blue-600 w-8">16px</span>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Tabs -->
        <div class="bg-white border-b border-slate-200">
            <div class="max-w-7xl mx-auto px-6">
                <div class="flex gap-6 overflow-x-auto no-scrollbar">
                    <button id="tabData" onclick="switchTab('data')"
                        class="py-4 text-base font-bold tab-active whitespace-nowrap">
                        <i class="fa-solid fa-database mr-2"></i>æ•¸æ“šä¾†æº
                    </button>
                    <button id="tabDashboard" onclick="switchTab('dashboard')"
                        class="py-4 text-base font-bold text-slate-500 hover:text-slate-700 whitespace-nowrap">
                        <i class="fa-solid fa-chart-simple mr-2"></i>è¦–è¦ºåŒ–åˆ†æ
                    </button>
                    <button id="tabStats" onclick="switchTab('stats')"
                        class="py-4 text-base font-bold text-slate-500 hover:text-slate-700 whitespace-nowrap">
                        <i class="fa-solid fa-calendar-day mr-2"></i>äººå“¡æ™‚æ•¸
                    </button>
                    <button id="tabReport" onclick="switchTab('report')"
                        class="py-4 text-base font-bold text-slate-500 hover:text-slate-700 whitespace-nowrap">
                        <i class="fa-solid fa-file-lines mr-2"></i>å ±å‘Šè¼¸å‡º
                    </button>
                    <button id="tabHistory" onclick="switchTab('history')"
                        class="py-4 text-base font-bold text-slate-500 hover:text-slate-700 whitespace-nowrap">
                        <i class="fa-solid fa-clock-rotate-left mr-2"></i>å°ˆæ¡ˆæ­·å²
                    </button>
                    <button id="tabLoop" onclick="switchTab('loop')"
                        class="py-4 text-base font-bold text-slate-500 hover:text-slate-700 whitespace-nowrap">
                        <i class="fa-solid fa-bolt-lightning mr-2"></i>é–‹ç™¼å¾ªç’°è¨ºæ–·
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="py-8">
        <div class="max-w-7xl mx-auto px-6">

            <!-- Tab 1: Data Source -->
            <section id="panelData" class="space-y-6">
                <!-- Filter Controls -->
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                    <h2 class="text-lg font-semibold mb-6 flex items-center">
                        <i class="fa-solid fa-sliders mr-2 text-blue-500"></i>
                        ç¯©é¸æ¢ä»¶
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                        <div>
                            <label class="block text-xs font-medium text-slate-500 mb-1.5">å°ˆæ¡ˆç¯©é¸</label>
                            <select id="filterProject" onchange="applyFilters()"
                                class="w-full bg-slate-50 border border-slate-300 rounded-lg px-3 py-2 text-sm">
                                <option value="">å…¨éƒ¨å°ˆæ¡ˆ</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-500 mb-1.5">é–‹å§‹æ—¥æœŸ</label>
                            <input type="date" id="filterStart"
                                class="w-full bg-slate-50 border border-slate-300 rounded-lg px-3 py-2 text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-500 mb-1.5">çµæŸæ—¥æœŸ</label>
                            <input type="date" id="filterEnd"
                                class="w-full bg-slate-50 border border-slate-300 rounded-lg px-3 py-2 text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-500 mb-1.5">äººå“¡ (å¯è¤‡é¸)</label>
                            <div id="filterEngineerContainer" class="relative">
                                <div id="engineerSelectDisplay" onclick="toggleEngineerDropdown()"
                                    class="w-full bg-slate-50 border border-slate-300 rounded-lg px-3 py-2 text-sm cursor-pointer flex justify-between items-center">
                                    <span id="selectedEngCount" class="truncate">å…¨éƒ¨äººå“¡</span>
                                    <i class="fa-solid fa-chevron-down text-[10px] text-slate-400"></i>
                                </div>
                                <div id="engineerDropdown"
                                    class="hidden absolute left-0 right-0 mt-1 bg-white border border-slate-200 rounded-lg shadow-lg z-[60] p-2 max-h-48 overflow-y-auto w-48 mx-auto md:w-full">
                                    <!-- Checkboxes will be inserted here -->
                                </div>
                            </div>
                        </div>
                        <div class="flex items-end">
                            <button onclick="applyFilters()"
                                class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors shadow-sm flex items-center justify-center gap-2 text-sm">
                                <i class="fa-solid fa-filter"></i>
                                å¥—ç”¨ç¯©é¸
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Data Source Options -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Option 1: Run Script (Recommended) -->
                    <div
                        class="bg-gradient-to-br from-amber-50 to-orange-50 rounded-2xl shadow-sm border border-amber-200 p-6 transition-all duration-300">
                        <h3 class="text-base font-semibold mb-4 flex items-center text-slate-800">
                            <i class="fa-solid fa-terminal mr-2 text-amber-600"></i>
                            æŒ‡ä»¤èˆ‡æ•¸æ“šæ›´æ–°
                        </h3>

                        <div class="mb-4">
                            <div class="flex justify-between items-center mb-1">
                                <p class="text-[10px] text-amber-700 font-bold">1. ç”Ÿæˆå°ˆæ¡ˆäº’å‹•æ­·å²</p>
                                <div class="flex items-center gap-2">
                                    <div class="flex items-center gap-1 border-r border-slate-200 pr-2">
                                        <i class="fa-solid fa-language text-[10px] text-slate-400"></i>
                                        <select id="targetLanguage"
                                            class="bg-transparent text-[10px] text-slate-500 border-none focus:ring-0 p-0 cursor-pointer">
                                            <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
                                            <option value="en">English</option>
                                            <option value="ja">æ—¥æœ¬èª</option>
                                        </select>
                                    </div>
                                    <button
                                        onclick="copyToClipboard('node generate_interaction_history.js --format=json')"
                                        class="text-[10px] text-amber-600 hover:text-amber-700 flex items-center gap-1 transition-colors font-medium">
                                        <i class="fa-solid fa-copy"></i> è¤‡è£½
                                    </button>
                                </div>
                            </div>
                            <div
                                class="bg-slate-900 border border-slate-700 text-slate-300 p-2 rounded-lg text-[9px] font-mono mb-2 shadow-inner">
                                node generate_interaction_history.js --format=json
                            </div>
                        </div>

                        <!-- Command Group 2: Usage -->
                        <div class="mb-4 pt-4 border-t border-amber-100">
                            <div class="flex items-center justify-between mb-1">
                                <p class="text-[10px] text-indigo-700 font-bold">2. æ›´æ–°æ¨¡å‹ä½¿ç”¨é‡</p>
                                <button onclick="copyToClipboard('node get_usage.js')"
                                    class="text-[10px] text-indigo-600 hover:text-indigo-700 flex items-center gap-1 transition-colors font-medium">
                                    <i class="fa-solid fa-copy"></i> è¤‡è£½
                                </button>
                            </div>
                            <div
                                class="bg-slate-900 border border-slate-700 text-slate-300 p-2 rounded-lg text-[9px] font-mono mb-2 shadow-inner">
                                node get_usage.js
                            </div>
                            <div class="flex items-center justify-between text-[10px] text-slate-500 mb-2">
                                <span><i class="fa-solid fa-clock-rotate-left mr-1 opacity-70"></i>é‡ç½®å€’æ•¸: <span
                                        id="usageCountdown"
                                        class="text-slate-800 font-bold font-mono">--:--:--</span></span>
                            </div>
                        </div>

                        <!-- Import Buttons -->
                        <div class="grid grid-cols-2 gap-3 mt-4">
                            <label
                                class="bg-white hover:bg-slate-50 text-slate-700 border border-slate-300 px-3 py-2 rounded-lg text-xs font-semibold transition-all flex items-center justify-center gap-2 cursor-pointer shadow-sm active:scale-95">
                                <i class="fa-solid fa-file-import text-amber-500"></i>
                                åŒ¯å…¥æ­·å²
                                <input type="file" id="historyJsonInput" accept=".json" class="hidden"
                                    onchange="loadEngineerData(event)">
                            </label>
                            <button onclick="uploadUsageFile()"
                                class="bg-white hover:bg-slate-50 text-slate-700 border border-slate-300 px-3 py-2 rounded-lg text-xs font-semibold transition-all flex items-center justify-center gap-2 shadow-sm active:scale-95">
                                <i class="fa-solid fa-chart-bar text-indigo-500"></i>
                                åŒ¯å…¥é‡èƒ½
                            </button>
                        </div>
                    </div>

                    <!-- Option 2: Antigravity Model Usage -->
                    <div
                        class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 relative overflow-hidden group">
                        <div class="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity">
                            <i class="fa-solid fa-chart-line text-4xl text-blue-500"></i>
                        </div>
                        <div class="flex justify-between items-start mb-4">
                            <h3 class="text-base font-semibold flex items-center text-slate-800">
                                <i class="fa-solid fa-microchip mr-2 text-indigo-500"></i>
                                ç•¶å‰æ¨¡å‹èƒ½è€—ç‹€æ…‹
                            </h3>
                            <span class="text-[10px] bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded">å¯¦æ™‚åˆ†æ</span>
                        </div>

                        <div id="modelUsageList" class="space-y-3">
                            <!-- Initial Loading State / Placeholder -->
                            <div class="flex flex-col items-center justify-center py-8 opacity-40">
                                <i class="fa-solid fa-database text-2xl mb-2"></i>
                                <p class="text-[10px]">è«‹é»æ“Šå·¦å´ã€ŒåŒ¯å…¥é‡èƒ½ã€è¼‰å…¥çœŸå¯¦æ•¸æ“š</p>
                            </div>
                        </div>
                    </div>

                    <!-- Option 3: Import Engineer Data -->
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                        <h3 class="text-base font-semibold mb-4 flex items-center">
                            <i class="fa-solid fa-users-gear mr-2 text-emerald-500"></i>
                            åŒ¯å…¥å·¥ç¨‹å¸«æ•¸æ“š
                        </h3>
                        <div class="mb-4">
                            <label class="block text-xs font-medium text-slate-500 mb-1">é¸æ“‡æˆ–è¼¸å…¥å·¥ç¨‹å¸«å§“å</label>
                            <input type="text" list="engineerList" id="engineerNameInput"
                                class="w-full bg-slate-50 border border-slate-300 rounded-lg px-3 py-2 text-sm"
                                placeholder="ä¾‹å¦‚: Arthur">
                            <datalist id="engineerList">
                                <option value="Arthur">
                                <option value="Steve">
                                <option value="Jessica">
                            </datalist>
                        </div>
                        <label
                            class="w-full bg-emerald-50 hover:bg-emerald-100 text-emerald-700 border border-emerald-200 px-4 py-3 rounded-lg font-medium transition-colors flex items-center justify-center gap-2 cursor-pointer">
                            <i class="fa-solid fa-file-import"></i>
                            åŒ¯å…¥è©²å“¡ JSON
                            <input type="file" id="engineerJsonInput" accept=".json" class="hidden"
                                onchange="loadEngineerData(event)">
                        </label>
                        <p class="text-xs text-slate-400 mt-3 text-center">å°‡æ•¸æ“šåˆä½µè‡³ç¾æœ‰è¦–åœ–</p>
                    </div>
                </div>

                <!-- Raw Data Preview -->
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-base font-semibold flex items-center">
                            <i class="fa-solid fa-table mr-2 text-amber-500"></i>
                            åŸå§‹æ•¸æ“šé è¦½
                        </h3>
                        <span id="dataCount"
                            class="text-xs px-3 py-1 bg-slate-100 text-slate-600 rounded-full">å°šæœªè¼‰å…¥</span>
                    </div>
                    <div class="overflow-x-auto overflow-y-auto max-h-[600px] border border-slate-100 rounded-xl">
                        <table class="w-full text-sm">
                            <thead class="text-xs text-slate-500 uppercase bg-slate-50 sticky top-0">
                                <tr>
                                    <th class="px-4 py-3 text-left w-16">åºè™Ÿ</th>
                                    <th class="px-4 py-3 text-left">å°è©±æ¨™é¡Œ</th>
                                    <th class="px-4 py-3 text-left">å°ˆæ¡ˆ</th>
                                    <th class="px-4 py-3 text-left">äººå“¡</th>
                                    <th class="px-4 py-3 text-left">é¡åˆ¥</th>
                                    <th class="px-4 py-3 text-right">å·¥æ™‚</th>
                                    <th class="px-4 py-3 text-left">æ›´æ–°æ™‚é–“</th>
                                </tr>
                            </thead>
                            <tbody id="rawDataTable">
                                <tr>
                                    <td colspan="5" class="px-4 py-8 text-center text-slate-400">è«‹é¸æ“‡æ•¸æ“šä¾†æº</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Tab 2: Dashboard -->
            <section id="panelDashboard" class="space-y-6 hidden">
                <!-- Summary Cards -->
                <div id="summaryCards" class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <!-- Placeholder -->
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm animate-pulse">
                        <div class="h-4 bg-slate-200 rounded w-1/2 mb-4"></div>
                        <div class="h-8 bg-slate-200 rounded w-1/3"></div>
                    </div>
                </div>

                <!-- Charts -->
                <!-- Row 1: Comparison & Composition -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Left: AI Variance Analysis -->
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                        <h3 class="text-base font-semibold mb-6 flex items-center">
                            <i class="fa-solid fa-scale-balanced mr-2 text-indigo-500"></i>
                            AI é ä¼° vs å¯¦éš›åå·®åˆ†æ
                        </h3>
                        <div id="categoryVarianceList" class="space-y-3">
                            <!-- Dynamic Content -->
                        </div>
                    </div>
                    <!-- Right: Category Composition -->
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                        <h3 class="text-base font-semibold mb-6 flex items-center">
                            <i class="fa-solid fa-chart-pie mr-2 text-rose-500"></i>
                            é¡åˆ¥æŠ•å…¥æ¯”ä¾‹
                        </h3>
                        <div class="relative h-72 flex items-center justify-center">
                            <canvas id="categoryChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Row 2: Time Distribution (Full Width) -->
                <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                    <h3 class="text-base font-semibold mb-6 flex items-center">
                        <i class="fa-solid fa-chart-bar mr-2 text-blue-500"></i>
                        å·¥æ™‚æŠ•å…¥åˆ†å¸ƒ (æŒ‰åºåˆ—ä»»å‹™)
                    </h3>
                    <div class="relative h-80">
                        <canvas id="hoursChart"></canvas>
                    </div>
                </div>

                <!-- Detail Table -->
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                    <div class="p-6 border-b border-slate-200">
                        <h3 class="text-base font-semibold flex items-center">
                            <i class="fa-solid fa-list-check mr-2 text-emerald-500"></i>
                            è©³ç´°è¨˜éŒ„åˆ—è¡¨
                        </h3>
                    </div>
                    <div class="overflow-x-auto overflow-y-auto max-h-[600px] border border-slate-100 rounded-xl">
                        <table class="w-full text-sm border-collapse">
                            <thead class="text-xs text-slate-500 uppercase bg-slate-50">
                                <tr>
                                    <th class="sticky top-0 bg-slate-50 px-6 py-3 text-left w-16 z-10 shadow-sm">åºè™Ÿ</th>
                                    <th class="sticky top-0 bg-slate-50 px-6 py-3 text-left z-10 shadow-sm">å°è©±æ¨™é¡Œ</th>
                                    <th class="sticky top-0 bg-slate-50 px-6 py-3 text-left z-10 shadow-sm">äººå“¡</th>
                                    <th
                                        class="sticky top-0 bg-slate-50 px-6 py-3 text-left min-w-[140px] z-10 shadow-sm">
                                        é¡åˆ¥
                                    </th>
                                    <th class="sticky top-0 bg-slate-50 px-6 py-3 text-left z-10 shadow-sm">ç‹€æ…‹</th>
                                    <th class="sticky top-0 bg-slate-50 px-6 py-3 text-right z-10 shadow-sm">å·¥æ™‚</th>
                                    <th class="sticky top-0 bg-slate-50 px-6 py-3 text-left z-10 shadow-sm">æ‘˜è¦</th>
                                </tr>
                            </thead>
                            <tbody id="detailTableBody">
                                <tr>
                                    <td colspan="5" class="px-6 py-8 text-center text-slate-400">è«‹å…ˆè¼‰å…¥æ•¸æ“š</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Tab 3: Report -->
            <section id="panelReport" class="space-y-6 hidden">
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                    <h2 class="text-lg font-semibold mb-6 flex items-center">
                        <i class="fa-solid fa-file-export mr-2 text-indigo-500"></i>
                        å ±å‘Šè¼¸å‡ºè¨­å®š
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                        <div>
                            <label class="block text-xs font-medium text-slate-500 mb-1.5">è¼¸å‡ºæ ¼å¼</label>
                            <select id="exportFormat"
                                class="w-full bg-slate-50 border border-slate-300 rounded-lg px-3 py-2 text-sm">
                                <option value="md">Markdown (.md)</option>
                                <option value="json">JSON (.json)</option>
                                <option value="dashboard">Dashboard æ ¼å¼ (.md)</option>
                            </select>
                        </div>
                        <div class="md:col-span-2 flex items-center gap-6 pt-6">
                            <label class="flex items-center gap-3 cursor-pointer text-sm font-bold text-slate-700">
                                <input type="checkbox" id="includeStaffStats" checked
                                    class="w-4 h-4 rounded text-indigo-600 focus:ring-indigo-500">
                                äººå“¡æ™‚æ•¸çµ±è¨ˆ
                            </label>
                            <label class="flex items-center gap-3 cursor-pointer text-sm font-bold text-slate-700">
                                <input type="checkbox" id="includeDailyStats" checked
                                    class="w-4 h-4 rounded text-indigo-600 focus:ring-indigo-500">
                                äººå“¡æ¯æ—¥å·¥æ™‚
                            </label>
                        </div>
                        <div class="flex items-end">
                            <button onclick="generateReport()"
                                class="w-full bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-medium transition-colors shadow-sm flex items-center justify-center gap-2 text-sm">
                                <i class="fa-solid fa-wand-magic-sparkles"></i>
                                ç”¢ç”Ÿå ±å‘Š
                            </button>
                        </div>
                        <div class="flex items-end">
                            <button onclick="downloadReport()"
                                class="w-full bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg font-medium transition-colors shadow-sm flex items-center justify-center gap-2 text-sm">
                                <i class="fa-solid fa-download"></i>
                                ä¸‹è¼‰å ±å‘Š
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Report Preview -->
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-base font-semibold flex items-center">
                            <i class="fa-solid fa-eye mr-2 text-blue-500"></i>
                            å ±å‘Šé è¦½
                        </h3>
                        <button onclick="copyReport()"
                            class="text-sm text-slate-500 hover:text-slate-700 flex items-center gap-1">
                            <i class="fa-solid fa-copy"></i> è¤‡è£½
                        </button>
                    </div>
                    <pre id="reportPreview"
                        class="code-block bg-slate-900 text-slate-300 p-6 rounded-xl text-sm overflow-auto max-h-[600px] whitespace-pre-wrap">
è«‹å…ˆè¼‰å…¥æ•¸æ“šä¸¦é»æ“Šã€Œç”¢ç”Ÿå ±å‘Šã€
                </pre>
                </div>
            </section>

            <!-- Tab 4: Project History -->
            <section id="panelHistory" class="space-y-6 hidden">
                <!-- Project Selection -->
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                    <h2 class="text-lg font-semibold mb-6 flex items-center">
                        <i class="fa-solid fa-folder-tree mr-2 text-amber-500"
                            title="ç”¢ç”Ÿæ ¼å¼åƒç…§ project_interaction_history.mdï¼ŒåŒ…å«å°ˆæ¡ˆæ¦‚è¿°ã€çµ±è¨ˆã€è©³ç´°äº’å‹•è¨˜éŒ„ç­‰ã€‚"></i>
                        å°ˆæ¡ˆé–‹ç™¼äº’å‹•æ­·å²æ¸…å–®
                        <i class="fa-solid fa-circle-info ml-2 text-slate-400 text-xs cursor-help"
                            title="ç”¢ç”Ÿæ ¼å¼åƒç…§ project_interaction_history.mdï¼ŒåŒ…å«å°ˆæ¡ˆæ¦‚è¿°ã€çµ±è¨ˆã€è©³ç´°äº’å‹•è¨˜éŒ„ç­‰ã€‚"></i>
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                        <div>
                            <label class="block text-xs font-medium text-slate-500 mb-1.5">é¸æ“‡å°ˆæ¡ˆ</label>
                            <select id="historyProjectSelect"
                                class="w-full bg-slate-50 border border-slate-300 rounded-lg px-3 py-2 text-sm">
                                <option value="">-- è«‹é¸æ“‡å°ˆæ¡ˆ --</option>
                            </select>
                        </div>
                        <div></div> <!-- Spacer -->
                        <div></div> <!-- Spacer -->
                        <div class="flex items-end">
                            <button onclick="generateProjectHistory()"
                                class="w-full bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded-lg font-medium transition-colors shadow-sm flex items-center justify-center gap-2 text-sm">
                                <i class="fa-solid fa-scroll"></i>
                                ç”¢ç”Ÿå°ˆæ¡ˆæ­·å²
                            </button>
                        </div>
                        <div class="flex items-end">
                            <button onclick="downloadProjectHistory()"
                                class="w-full bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg font-medium transition-colors shadow-sm flex items-center justify-center gap-2 text-sm">
                                <i class="fa-solid fa-download"></i>
                                ä¸‹è¼‰å ±å‘Š
                            </button>
                        </div>
                    </div>
                </div>

                <!-- History Preview -->
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-base font-semibold flex items-center">
                            <i class="fa-solid fa-eye mr-2 text-blue-500"></i>
                            å°ˆæ¡ˆæ­·å²å ±å‘Šé è¦½
                        </h3>
                        <button onclick="copyProjectHistory()"
                            class="text-sm text-slate-500 hover:text-slate-700 flex items-center gap-1">
                            <i class="fa-solid fa-copy"></i> è¤‡è£½
                        </button>
                    </div>
                    <pre id="historyPreview"
                        class="code-block bg-slate-900 text-slate-300 p-6 rounded-xl text-sm overflow-auto max-h-[600px] whitespace-pre-wrap">
è«‹é¸æ“‡å°ˆæ¡ˆä¸¦é»æ“Šã€Œç”¢ç”Ÿå°ˆæ¡ˆæ­·å²ã€
                </pre>
                </div>
            </section>

            <!-- Tab 5: Staff Daily Stats -->
            <section id="panelStats" class="space-y-6 hidden">
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-lg font-semibold flex items-center">
                            <i class="fa-solid fa-calendar-check mr-2 text-indigo-500"></i>
                            äººå“¡æ¯æ—¥å·¥æ™‚çµ±è¨ˆ
                        </h2>
                        <div class="bg-indigo-50 text-indigo-700 px-3 py-1 rounded-full text-xs font-medium">
                            è‡ªå‹•å½™æ•´æ•¸æ“š
                        </div>
                    </div>

                    <div class="overflow-x-auto overflow-y-auto max-h-[600px] border border-slate-100 rounded-xl">
                        <table class="w-full text-sm border-collapse">
                            <thead id="statsTableHeader"
                                class="bg-slate-50 text-slate-500 font-medium sticky top-0 z-10 shadow-sm border-b border-slate-200">
                                <!-- Headers will be dynamic -->
                            </thead>
                            <tbody id="statsTableBody" class="divide-y divide-slate-100">
                                <!-- Rows will be dynamic -->
                            </tbody>
                        </table>
                    </div>

                    <div class="mt-6 p-4 bg-slate-50 rounded-xl border border-dashed border-slate-300">
                        <p class="text-xs text-slate-500 italic text-center">
                            <i class="fa-solid fa-info-circle mr-1"></i>
                            çµ±è¨ˆå°è±¡ç‚ºç›®å‰å·²åŒ¯å…¥ä¸”ç¬¦åˆç¯©é¸æ¢ä»¶çš„æ‰€æœ‰äººå“¡å°è©±è¨˜éŒ„ã€‚
                        </p>
                    </div>
                </div>
            </section>

            <!-- Tab 6: Dev-Loop Diagnostics -->
            <section id="panelLoop" class="space-y-6 hidden">
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-lg font-semibold flex items-center">
                            <i class="fa-solid fa-bolt-lightning mr-2 text-yellow-500"></i>
                            é–‹ç™¼å¾ªç’°æ•ˆèƒ½è¨ºæ–· (Dev-Loop)
                        </h2>
                        <div class="text-xs text-slate-400">
                            åˆ†æã€ŒAI å›ç­”å¾Œã€è‡³ã€Œä½¿ç”¨è€…ä¸‹æ¬¡æå•ã€çš„æ¶ˆåŒ–èˆ‡ç ”ç™¼æ•ˆç‡
                        </div>
                    </div>

                    <div class="overflow-x-auto overflow-y-auto max-h-[600px] border border-slate-100 rounded-xl">
                        <table class="w-full text-sm border-collapse">
                            <thead class="text-slate-500 font-medium">
                                <tr class="bg-slate-50">
                                    <th class="sticky top-0 bg-slate-50 px-6 py-4 text-left z-10 shadow-sm w-16">åºè™Ÿ</th>
                                    <th class="sticky top-0 bg-slate-50 px-6 py-4 text-left z-10 shadow-sm w-32">äººå“¡</th>
                                    <th class="sticky top-0 bg-slate-50 px-6 py-4 text-left z-10 shadow-sm">å°è©±åºåˆ— (ä»»å‹™)
                                    </th>
                                    <th class="sticky top-0 bg-slate-50 px-6 py-4 text-center z-10 shadow-sm">ä»»å‹™è¤‡é›œåº¦</th>
                                    <th class="sticky top-0 bg-slate-50 px-6 py-4 text-center z-10 shadow-sm">å¯¦éš›æ¶ˆåŒ–</th>
                                    <th class="sticky top-0 bg-slate-50 px-6 py-4 text-center z-10 shadow-sm">ç¸½æ™‚é•·</th>
                                    <th class="sticky top-0 bg-slate-50 px-6 py-4 text-center z-10 shadow-sm">åˆç†æ™‚é–“</th>
                                    <th class="sticky top-0 bg-slate-50 px-6 py-4 text-left z-10 shadow-sm">æ•ˆç‡è©•åƒ¹</th>
                                </tr>
                            </thead>
                            <tbody id="loopTableBody" class="divide-y divide-slate-100">
                                <!-- Rows will be dynamic -->
                            </tbody>
                        </table>
                    </div>

                    <div
                        class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-6 bg-slate-50 p-6 rounded-2xl border border-slate-200">
                        <div>
                            <h4 class="text-sm font-bold text-slate-800 mb-2">ğŸ“Š è¨ºæ–·æ¨™æº–èªªæ˜</h4>
                            <ul class="text-xs text-slate-500 space-y-2">
                                <li><span class="text-indigo-600 font-bold">â— å¯¦éš›æ¶ˆåŒ–æ™‚é–“</span>: æ¸¬é‡å…©æ¬¡ä»»å‹™é–“çš„ã€Œé–‹ç™¼è€…ç ”ç©¶/æ¸¬è©¦ã€æ™‚æ®µã€‚è‹¥è¶…é 2
                                    å°æ™‚ï¼Œç³»çµ±æœƒè‡ªå‹•æ ¡æ­£ç‚ºåˆç†å€¼ (é¡¯ç¤º ğŸŒ™)ï¼Œä¸å½±éŸ¿æ•ˆèƒ½è©•æ¯”ã€‚</li>
                                <li><span class="text-emerald-600 font-bold">â— ç¸½æ™‚é•·</span>: æœ¬æ¬¡å°è©±çš„æœ€çµ‚æŠ•å…¥å·¥æ™‚ (åŸ·è¡Œ + ç ”ç©¶)ã€‚</li>
                                <li><span class="text-amber-600 font-bold">â— æ•ˆç‡è©•åƒ¹</span>: å°æ¯”å¯¦éš›èˆ‡ AI ä¼°ç®—æ™‚é–“ã€‚å·®è· Â±30%
                                    å…§è¦–ç‚ºã€Œç²¾æº–ã€ï¼Œä»£è¡¨é–‹ç™¼èˆ‡ AI çš„ç¯€å¥é…åˆå®Œç¾ã€‚</li>
                            </ul>
                        </div>
                        <div>
                            <h4 class="text-sm font-bold text-slate-800 mb-2">ğŸ§  æ¼”ç®—æ³•æ ¸å¿ƒ (Formula)</h4>
                            <p class="text-xs text-slate-500 leading-relaxed font-mono">
                                AI ä¼°ç®—åˆç†æ™‚é–“ = 6m (åŸºç¤) + (è¤‡é›œåº¦è©•åˆ† Ã— 4m)<br>
                                è¤‡é›œåº¦è©•åˆ† = (æª”æ¡ˆå¤§å°/100KB) + (Artifacts Ã— 2)<br>
                                ç¸½æ™‚é•· = åŸ·è¡Œå·¥æ™‚ (LifeSpan * 0.8) + æœ‰æ•ˆç ”ç©¶å·¥æ™‚
                            </p>
                        </div>
                    </div>
                </div>
            </section>

        </div>
    </main>

    <script>
        // ====== Global State ======
        let currentData = [];
        let hoursChartIns = null;
        let categoryChartIns = null;



        // ====== Tab Switching ======
        function switchTab(tabName) {
            // Hide all panels - updated selector to handle alignment div
            document.querySelectorAll('main div > section').forEach(section => {
                section.classList.add('hidden');
            });

            // Reset tab styles
            ['tabData', 'tabDashboard', 'tabHistory', 'tabReport', 'tabStats', 'tabLoop'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.classList.remove('tab-active');
                    el.classList.add('text-slate-500');
                }
            });

            // Show selected panel and activate tab
            document.getElementById('panel' + tabName.charAt(0).toUpperCase() + tabName.slice(1)).classList.remove('hidden');
            document.getElementById('tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1)).classList.add('tab-active');
            document.getElementById('tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1)).classList.remove('text-slate-500');
        }

        // ====== Helper Functions ======
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('âœ… æŒ‡ä»¤å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼Œè«‹è‡³çµ‚ç«¯æ©ŸåŸ·è¡Œ');
            });
        }

        // ====== Data Loading ======
        function loadEngineerData(event) {
            const engineerName = document.getElementById('engineerNameInput').value.trim();
            if (!engineerName) {
                alert('è«‹å…ˆè¼¸å…¥æˆ–é¸æ“‡å·¥ç¨‹å¸«å§“åï¼é€™å°æ–¼æ•¸æ“šæ­¸é¡éå¸¸é—œéµã€‚');
                event.target.value = ''; // Reset file input
                return;
            }

            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function (e) {
                try {
                    const jsonData = JSON.parse(e.target.result);
                    let newData = [];
                    if (jsonData.conversations) {
                        newData = jsonData.conversations;
                    } else if (Array.isArray(jsonData)) {
                        newData = jsonData;
                    }

                    // --- Integrity Verification ---
                    if (jsonData.integrity) {
                        // ä¿®æ­£ï¼šæª¢æŸ¥ç€è¦½å™¨æ˜¯å¦æ”¯æ´ crypto (file:// æ¨¡å¼ä¸‹å¯èƒ½ä¸æ”¯æ´)
                        if (window.isSecureContext && window.crypto && window.crypto.subtle) {
                            const content = JSON.stringify(newData);
                            const msgUint8 = new TextEncoder().encode(content);
                            const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8);
                            const hashArray = Array.from(new Uint8Array(hashBuffer));
                            const calculatedHash = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

                            if (calculatedHash !== jsonData.integrity) {
                                if (!confirm('âš ï¸ è­¦å‘Šï¼šè³‡æ–™å®Œæ•´æ€§æª¢æŸ¥å¤±æ•—ï¼æ­¤æª”æ¡ˆçš„å…§å®¹å¯èƒ½å·²è¢«æ‰‹å‹•ä¿®æ”¹éã€‚\n\næ˜¯å¦ä»è¦å¼·åˆ¶åŒ¯å…¥ï¼Ÿ')) {
                                    event.target.value = '';
                                    return;
                                }
                            } else {
                                console.log('âœ… è³‡æ–™å®Œæ•´æ€§é©—è­‰é€šé');
                            }
                        } else {
                            console.warn('âš ï¸ åµæ¸¬åˆ°éå®‰å…¨ç’°å¢ƒ (file://)ï¼Œè‡ªå‹•è·³éå®Œæ•´æ€§ç°½ç« é©—è­‰ã€‚');
                        }
                    }

                    // Attach engineer name to each record and preserve originals for translation
                    newData = newData.map(c => ({
                        ...c,
                        engineer: engineerName,
                        _origTitle: c.title,
                        _origSummary: c.summary
                    }));

                    // Append and unique
                    currentData = currentData.concat(newData);

                    // Deduplicate by ID
                    const uniqueData = Array.from(new Map(currentData.map(item => [item.id, item])).values());

                    // --- é‡è¦ï¼šå»ºç«‹å…¨åŸŸä¸€è‡´çš„åºè™Ÿç³»çµ± ---
                    // 1. ä¾ç…§æ™‚é–“æ­£åºæ’åˆ—
                    uniqueData.sort((a, b) => new Date(a.modifiedTime) - new Date(b.modifiedTime));

                    // 2. åˆ†é…æ°¸ä¹…åºè™Ÿ _seq
                    currentData = uniqueData.map((c, idx) => ({
                        ...c,
                        _seq: idx + 1
                    }));

                    // Trigger auto-translation if needed
                    await batchTranslateMetadata();

                    updateEngineerFilterOptions();
                    updateProjectFilterOptions();
                    applyFilters();
                    alert(`âœ… å·²åŒ¯å…¥å·¥ç¨‹å¸« ${engineerName} çš„è³‡æ–™ï¼Œå…± ${newData.length} ç­†ï¼`);
                } catch (err) {
                    alert('âŒ JSON è§£æå¤±æ•—: ' + err.message);
                }
            };
            reader.readAsText(file);
        }

        // ====== Filter Utilities ======
        function toggleEngineerDropdown() {
            const dropdown = document.getElementById('engineerDropdown');
            if (dropdown) dropdown.classList.toggle('hidden');
        }

        // ====== Translation Logic ======
        async function translateText(text, targetLang) {
            if (!text || text.trim() === '') return text;
            try {
                const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=${targetLang}&dt=t&q=${encodeURIComponent(text)}`;
                const response = await fetch(url);
                const data = await response.json();
                return data[0].map(item => item[0]).join('');
            } catch (err) {
                console.error('Translation failed:', err);
                return text;
            }
        }

        async function batchTranslateMetadata() {
            const targetLang = document.getElementById('targetLanguage').value;
            const loadingOverlay = showLoading('æ­£åœ¨è½‰æ›èªè¨€å…§å®¹...');

            try {
                for (let conv of currentData) {
                    // Start translation for title and summary if they haven't been translated to this lang yet
                    if (!conv._lastLang || conv._lastLang !== targetLang) {
                        const titleToTranslate = conv._origTitle || conv.title;
                        const summaryToTranslate = conv._origSummary || conv.summary;

                        // Concurrent translation for performance within one conversation
                        const [tTitle, tSummary] = await Promise.all([
                            translateText(titleToTranslate, targetLang),
                            translateText(summaryToTranslate, targetLang)
                        ]);

                        conv.title = tTitle;
                        conv.summary = tSummary;
                        conv._lastLang = targetLang;
                    }
                }
            } finally {
                hideLoading(loadingOverlay);
            }
        }

        function showLoading(msg) {
            const overlay = document.createElement('div');
            overlay.className = 'fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[100] flex items-center justify-center';
            overlay.innerHTML = `
                <div class="bg-white p-6 rounded-2xl shadow-xl flex flex-col items-center gap-4">
                    <div class="animate-spin text-blue-600 text-3xl"><i class="fa-solid fa-spinner"></i></div>
                    <p class="text-sm font-medium text-slate-700">${msg}</p>
                </div>
            `;
            document.body.appendChild(overlay);
            return overlay;
        }

        function hideLoading(overlay) {
            if (overlay && overlay.parentNode) {
                overlay.parentNode.removeChild(overlay);
            }
        }

        // Add listener for language change
        document.getElementById('targetLanguage').addEventListener('change', async () => {
            await batchTranslateMetadata();
            applyFilters();
        });

        // Close dropdown when clicking outside
        window.addEventListener('click', function (e) {
            const container = document.getElementById('filterEngineerContainer');
            if (container && !container.contains(e.target)) {
                const dropdown = document.getElementById('engineerDropdown');
                if (dropdown) dropdown.classList.add('hidden');
            }
        });

        function updateProjectFilterOptions() {
            const projects = [...new Set(currentData.map(c => c.project))].filter(p => p && p !== 'æœªåˆ†é¡').sort();
            const filterProject = document.getElementById('filterProject');
            const historyProjectSelect = document.getElementById('historyProjectSelect');

            // Clear and add "All" option for main filter
            const currentProjFilter = filterProject.value;
            filterProject.innerHTML = '<option value="">å…¨éƒ¨å°ˆæ¡ˆ</option>';
            projects.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p;
                opt.textContent = p;
                filterProject.appendChild(opt);
            });
            filterProject.value = currentProjFilter; // Restore selection if possible

            // Clear and add "Select" option for history filter
            const currentHistFilter = historyProjectSelect.value;
            historyProjectSelect.innerHTML = '<option value="">-- è«‹é¸æ“‡å°ˆæ¡ˆ --</option>';
            projects.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p;
                opt.textContent = p;
                historyProjectSelect.appendChild(opt);
            });
            historyProjectSelect.value = currentHistFilter;
        }

        function updateEngineerFilterOptions() {
            const engineers = [...new Set(currentData.filter(c => c.engineer).map(c => c.engineer))];
            const dropdown = document.getElementById('engineerDropdown');
            if (!dropdown) return;

            dropdown.innerHTML = engineers.length === 0
                ? '<p class="text-xs text-slate-400 p-2 text-center">ç„¡äººå“¡è³‡æ–™</p>'
                : engineers.map(name => `
                    <label class="flex items-center gap-2 p-1.5 hover:bg-slate-50 rounded cursor-pointer text-sm">
                        <input type="checkbox" name="engFilter" value="${name}" checked onchange="updateSelectedEngCount()" class="rounded text-blue-600 focus:ring-blue-500">
                        ${name}
                    </label>
                `).join('');

            updateSelectedEngCount();
        }

        function updateSelectedEngCount() {
            const checks = document.querySelectorAll('input[name="engFilter"]:checked');
            const total = document.querySelectorAll('input[name="engFilter"]').length;
            const display = document.getElementById('selectedEngCount');
            if (!display) return;

            if (checks.length === 0) {
                display.textContent = 'æœªé¸æ“‡äººå“¡';
                display.classList.add('text-red-500');
            } else if (checks.length === total) {
                display.textContent = 'å…¨éƒ¨äººå“¡';
                display.classList.remove('text-red-500');
            } else {
                display.textContent = `å·²é¸æ“‡ ${checks.length} äºº`;
                display.classList.remove('text-red-500');
            }
        }

        function getFilteredData() {
            const projectFilter = document.getElementById('filterProject').value;
            const startDateStr = document.getElementById('filterStart').value;
            const endDateStr = document.getElementById('filterEnd').value;
            const startDate = startDateStr ? new Date(startDateStr) : null;
            const endDate = endDateStr ? new Date(endDateStr + 'T23:59:59') : null;

            const selectedEngs = Array.from(document.querySelectorAll('input[name="engFilter"]:checked')).map(cb => cb.value);

            return currentData.filter(c => {
                if (projectFilter && c.project !== projectFilter) return false;
                if (selectedEngs.length > 0 && !selectedEngs.includes(c.engineer)) return false;

                const cDate = new Date(c.modifiedTime);
                if (startDate && cDate < startDate) return false;
                if (endDate && cDate > endDate) return false;
                return true;
            });
        }

        function applyFilters() {
            const filtered = getFilteredData();
            renderRawTable(filtered);
            renderDashboard(filtered);
            renderStaffDailyStats(filtered);
            renderDevLoop(filtered); // Ensure this is called with filtered data that contains researchHours
            document.getElementById('dataCount').textContent = `${filtered.length} ç­†è³‡æ–™`;
        }

        function renderDevLoop(data) {
            const body = document.getElementById('loopTableBody');
            if (!body) return;

            if (data.length < 2) {
                body.innerHTML = `<tr><td colspan="7" class="px-6 py-10 text-center text-slate-400">æ•¸æ“šä¸è¶³ (éœ€è‡³å°‘ 2 ç­†å°è©±) ä»¥é€²è¡Œé–“éš”åˆ†æ</td></tr>`;
                return;
            }

            body.innerHTML = data.map((c, i) => {
                const gapMinutes = c.thinkingGapMinutes || 0;
                const reasonableTime = Math.round((c.complexityScore || 1) * 4 + 6);
                // æ ¸å¿ƒè©•åƒ¹é‚è¼¯ - æ”¹ç”¨ã€Œç¸½æ™‚é•· (c.hours)ã€ä½œç‚ºè©•åƒ¹åŸºæº–
                const totalWorkMins = Math.round((c.hours || 0) * 60);
                const efficiencyPct = Math.round((totalWorkMins / (reasonableTime || 1)) * 100);

                let performance, statusClass, light;
                if (totalWorkMins < (reasonableTime * 0.5)) {
                    performance = 'å“è¶Š (è¶…æ•ˆ)';
                    statusClass = 'text-indigo-600 font-bold';
                    light = 'ğŸŸ¢';
                } else if (totalWorkMins < (reasonableTime * 1.3)) {
                    performance = 'æ·±åº¦æ¶ˆåŒ– (ç²¾æº–)';
                    statusClass = 'text-emerald-600 font-bold';
                    light = 'ğŸŸ¢';
                } else if (totalWorkMins < (reasonableTime * 2.5)) {
                    performance = 'éœ€è¦æ›´å¤šæ¸¬è©¦ (æ™®é€š)';
                    statusClass = 'text-amber-600';
                    light = 'ğŸŸ¡';
                } else {
                    performance = 'é‡åˆ°ç“¶é ¸ (é²ç·©)';
                    statusClass = 'text-rose-600';
                    light = 'ğŸ”´';
                }

                const efficiencyTooltip = `æ•ˆç‡è¨ˆç®—: ${totalWorkMins}m (å¯¦éš›) / ${reasonableTime}m (åˆç†) = ${efficiencyPct}%`;

                // è™•ç†æ ¡æ­£æ¨™è¨» (å–ä»£åŸæœ¬çš„æˆ°ç•¥æ€§ä¼‘æ¯æ¨™ç±¤)
                let correctedSuffix = '';
                let moonIcon = '';
                if (i > 0 && c.researchHours > 0 && gapMinutes > 120) {
                    correctedSuffix = ' (æ ¡æ­£å¾Œ)';
                    moonIcon = 'ğŸŒ™ ';
                    statusClass += ' italic';
                }

                // ç¬¬ä¸€ç­†ç‰¹åˆ¥æ¨™è¨» (èµ·è¨–ä»ä¿ç•™è©•åƒ¹)
                if (i === 0) {
                    performance = 'å°ˆæ¡ˆå•Ÿå‹• / ' + performance;
                }

                const formatTime = (timeInMin) => {
                    if (i === 0 && timeInMin === 0) return '-';
                    const mins = Math.round(timeInMin);
                    return mins >= 60 ? `${(mins / 60).toFixed(1)}h` : `${mins}m`;
                };

                const formatHourMin = (isoStr) => {
                    const d = new Date(isoStr);
                    const month = (d.getMonth() + 1).toString().padStart(2, '0');
                    const day = d.getDate().toString().padStart(2, '0');
                    const h = d.getHours().toString().padStart(2, '0');
                    const m = d.getMinutes().toString().padStart(2, '0');
                    const s = d.getSeconds().toString().padStart(2, '0');
                    return `${month}/${day} ${h}:${m}:${s}`;
                };

                // è¨ˆç®—ã€Œå¾ªç’°è€—æ™‚ã€(Cycle Time): å¾ä¸Šä¸€ç­†çµæŸåˆ°æœ¬ç­†çµæŸçš„åŸå§‹ç‰©ç†æ™‚é–“
                let durationMs = 0;
                if (i > 0) {
                    durationMs = new Date(c.modifiedTime) - new Date(data[i - 1].modifiedTime);
                } else {
                    durationMs = new Date(c.modifiedTime) - new Date(c.createdTime);
                }

                const durHours = Math.floor(durationMs / 3600000);
                const durMin = Math.floor((durationMs % 3600000) / 60000);
                const durSec = Math.floor((durationMs % 60000) / 1000);

                let durationLabel = "";
                if (durHours > 0) {
                    durationLabel = `${durHours}h ${durMin}m`;
                } else if (durMin > 0) {
                    durationLabel = `${durMin}m ${durSec}s`;
                } else {
                    durationLabel = `${durSec}s`;
                }

                const timeRange = `${formatHourMin(c.createdTime)} - ${formatHourMin(c.modifiedTime)} <span class="bg-indigo-100/50 text-indigo-600 px-2 py-0.5 rounded-md ml-2 font-mono font-medium shadow-sm" title="åŸå§‹ç‰©ç†å¾ªç’°è€—æ™‚ (å«é–“éš”)">è€—æ™‚: ${durationLabel}</span>`;

                const displayTime = Math.round((c.activeHours || 0) * 60);

                return `
                    <tr class="hover:bg-slate-50 transition-colors">
                        <td class="px-6 py-4 text-slate-400 text-xs">${c._seq}</td>
                        <td class="px-6 py-4">
                            <span class="inline-flex items-center px-2 py-1 rounded-md text-xs font-semibold bg-slate-100 text-slate-700 dark-theme-badge shadow-sm border border-slate-200">
                                <i class="fa-solid fa-user-gear mr-1.5 text-slate-400"></i>${c.engineer || 'æœªæŒ‡å®š'}
                            </span>
                        </td>
                        <td class="px-6 py-4">
                            <div class="font-medium text-slate-800 text-base mb-1">
                                ${c.title} ${c._manual ? '<span class="text-indigo-500 text-[10px] ml-1 opacity-70" title="è‡ªå®šç¾©å‹˜èª¤æ¨™é¡Œ">ğŸ“</span>' : ''}
                            </div>
                            <div class="text-xs text-slate-500 flex items-center gap-1">
                                <i class="fa-regular fa-clock opacity-60"></i>${timeRange}
                            </div>
                        </td>
                        <td class="px-6 py-4 text-center">
                            <span class="bg-slate-100 text-slate-600 dark-theme-badge px-2 py-0.5 rounded text-xs border border-slate-200">LV.${Math.ceil(c.complexityScore)}</span>
                        </td>
                        <td class="px-6 py-4 text-center font-mono ${displayTime >= 60 ? 'text-amber-600' : 'text-slate-700'}">
                            ${formatTime(displayTime)}
                        </td>
                        <td class="px-6 py-4 text-center font-mono text-slate-700 font-bold">
                            ${formatTime(c.hours * 60)}
                        </td>
                        <td class="px-6 py-4 text-center font-mono text-slate-500">
                            ~${formatTime(reasonableTime)}
                        </td>
                        <td class="px-6 py-4 text-left text-xs ${statusClass}" title="${efficiencyTooltip}">
                            ${light} ${moonIcon}${performance}${correctedSuffix}
                        </td>
                    </tr>
                `;
            }).reverse().join(''); // Show latest on top
        }

        function renderStaffDailyStats(data) {
            const engineers = [...new Set(data.filter(c => c.engineer).map(c => c.engineer))].sort();
            const dailyData = {};

            data.forEach(c => {
                const eng = c.engineer || 'æœªæŒ‡å®š';
                const startTime = new Date(c.createdTime);
                const endTime = new Date(c.modifiedTime);
                const totalHours = c.hours || 0;

                // å¦‚æœèµ·å§‹æ™‚é–“ç›¸åŒæˆ–ç„¡æ•ˆï¼Œé€€å›åˆ°èˆŠé‚è¼¯
                if (endTime <= startTime || isNaN(startTime.getTime())) {
                    const date = endTime.toLocaleDateString('zh-TW');
                    if (!dailyData[date]) dailyData[date] = {};
                    if (!dailyData[date][eng]) dailyData[date][eng] = 0;
                    dailyData[date][eng] += totalHours;
                    return;
                }

                // è¨ˆç®—è·¨è¶Šçš„å¤©æ•¸
                let tempStart = new Date(startTime);
                const totalSpanMs = endTime - startTime;

                while (tempStart < endTime) {
                    const nextDay = new Date(tempStart);
                    nextDay.setHours(24, 0, 0, 0); // è¨­å®šç‚ºç•¶å¤©åˆå¤œ (éš”å¤© 00:00)

                    const endOfSegment = nextDay < endTime ? nextDay : endTime;
                    const segmentMs = endOfSegment - tempStart;
                    const segmentRatio = segmentMs / totalSpanMs;
                    const segmentHours = totalHours * segmentRatio;

                    const dateStr = tempStart.toLocaleDateString('zh-TW');
                    if (!dailyData[dateStr]) dailyData[dateStr] = {};
                    if (!dailyData[dateStr][eng]) dailyData[dateStr][eng] = 0;
                    dailyData[dateStr][eng] += segmentHours;

                    tempStart = nextDay;
                }
            });

            const dates = Object.keys(dailyData).sort((a, b) => new Date(b) - new Date(a));
            const header = document.getElementById('statsTableHeader');
            const body = document.getElementById('statsTableBody');

            // Render Header
            header.innerHTML = `
                <tr>
                    <th class="px-6 py-4 text-left">æ—¥æœŸ</th>
                    ${engineers.map(eng => `<th class="px-6 py-4 text-center">${eng}</th>`).join('')}
                    <th class="px-6 py-4 text-right">ç•¶æ—¥ç¸½è¨ˆ</th>
                </tr>
            `;

            // Render Body
            if (dates.length === 0) {
                body.innerHTML = `<tr><td colspan="${engineers.length + 2}" class="px-6 py-10 text-center text-slate-400">å°šç„¡ç¬¦åˆæ¢ä»¶çš„æ™‚æ•¸çµ±è¨ˆ</td></tr>`;
                return;
            }

            body.innerHTML = dates.map(date => {
                const engHours = engineers.map(eng => dailyData[date][eng] || 0);
                const dayTotal = engHours.reduce((s, h) => s + h, 0);
                return `
                    <tr class="hover:bg-slate-50 transition-colors">
                        <td class="px-6 py-4 font-medium text-slate-700">${date}</td>
                        ${engHours.map(h => `
                            <td class="px-6 py-4 text-center ${h > 0 ? 'text-indigo-600 font-semibold' : 'text-slate-300'}">
                                ${h > 0 ? h.toFixed(1) + 'h' : '-'}
                            </td>
                        `).join('')}
                        <td class="px-6 py-4 text-right font-bold text-slate-900 bg-slate-50/50 stats-col-total">${dayTotal.toFixed(1)}h</td>
                    </tr>
                `;
            }).join('');
        }

        // ====== Rendering ======
        function renderRawTable(data) {
            const tbody = document.getElementById('rawDataTable');
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-slate-400">ç„¡ç¬¦åˆæ¢ä»¶çš„è³‡æ–™</td></tr>';
                return;
            }

            tbody.innerHTML = data.map((c, index) => `
                <tr class="border-b border-slate-100 hover:bg-slate-50">
                    <td class="px-4 py-3 text-slate-400 text-xs cursor-help" title="${c.summary || 'ç„¡æ‘˜è¦'}">${c._seq}</td>
                    <td class="px-4 py-3 font-medium">
                        ${c.title} ${c._manual ? '<span class="text-indigo-500 text-[10px] ml-1 opacity-70" title="è‡ªå®šç¾©å‹˜èª¤æ¨™é¡Œ">ğŸ“</span>' : ''}
                    </td>
                    <td class="px-4 py-3 text-xs">${c.project}</td>
                    <td class="px-4 py-3 text-xs text-slate-600">${c.engineer || '-'}</td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-0.5 rounded-full text-xs ${getCategoryBadge(c.category)}">${c.category}</span>
                    </td>
                    <td class="px-4 py-3 text-right font-mono">${c.hours}h</td>
                    <td class="px-4 py-3 text-slate-500 text-xs">${new Date(c.modifiedTime).toLocaleDateString('zh-TW')}</td>
                </tr>
            `).join('');
        }

        function getCategoryBadge(category) {
            const isDark = document.documentElement.getAttribute('data-theme') !== 'light';
            const map = {
                'DEBUG': isDark ? 'bg-red-500/20 text-red-300 border border-red-500/30' : 'bg-red-50 text-red-700',
                'UI èª¿æ•´': isDark ? 'bg-purple-500/20 text-purple-300 border border-purple-500/30' : 'bg-purple-50 text-purple-700',
                'æ¶æ§‹è®Šæ›´': isDark ? 'bg-blue-500/20 text-blue-300 border border-blue-500/30' : 'bg-blue-50 text-blue-700',
                'çŸ¥è­˜æ”¶é›†': isDark ? 'bg-green-500/20 text-green-300 border border-green-500/30' : 'bg-green-50 text-green-700',
                'è³‡æ–™è™•ç†': isDark ? 'bg-amber-500/20 text-amber-300 border border-amber-500/30' : 'bg-amber-50 text-amber-700',
                'é–‹ç™¼æ¨¡å¼': isDark ? 'bg-sky-500/20 text-sky-300 border border-sky-500/30' : 'bg-sky-50 text-sky-700'
            };
            return map[category] || (isDark ? 'bg-slate-700 text-slate-300' : 'bg-slate-100 text-slate-700');
        }

        function renderDashboard(data) {
            // è¨ˆç®—ç¸½é‡èˆ‡é ä¼°é‡
            const totalHours = data.reduce((s, c) => s + c.hours, 0);
            const totalEstMins = data.reduce((s, c) => s + (Math.round((c.complexityScore || 1) * 4 + 6)), 0);
            const totalEstHours = totalEstMins / 60;
            const totalVariance = totalHours - totalEstHours;
            const totalVarPct = ((totalVariance / (totalEstHours || 1)) * 100).toFixed(1);

            const projects = [...new Set(data.map(c => c.project))];
            const categories = {};
            data.forEach(c => {
                const estH = (Math.round((c.complexityScore || 1) * 4 + 6)) / 60;
                if (!categories[c.category]) categories[c.category] = { count: 0, hours: 0, estHours: 0 };
                categories[c.category].count++;
                categories[c.category].hours += c.hours;
                categories[c.category].estHours += estH;
            });

            // æ›´æ–°æ‘˜è¦å¡ç‰‡å®¹å™¨æ¨£å¼ç‚º 5 æ¬„ (èª¿æ•´ padding ä»¥é©æ‡‰æ›´å¤šå¡ç‰‡)
            const cardsContainer = document.getElementById('summaryCards');
            cardsContainer.className = "grid grid-cols-1 md:grid-cols-5 gap-4";

            const varColor = totalVariance > 0 ? 'text-rose-600' : 'text-emerald-600';
            const varIcon = totalVariance > 0 ? 'fa-arrow-trend-up' : 'fa-arrow-trend-down';

            cardsContainer.innerHTML = `
                <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm flex items-center justify-between">
                    <div><p class="text-xs text-slate-500 mb-1 font-semibold">å°è©±ç¸½æ•¸</p><h3 class="text-2xl font-bold">${data.length}</h3></div>
                    <div class="bg-blue-50/50 p-3 rounded-full text-blue-600"><i class="fa-solid fa-comments text-lg"></i></div>
                </div>
                <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm flex items-center justify-between">
                    <div><p class="text-xs text-slate-500 mb-1 font-semibold">å¯¦éš›å·¥æ™‚</p><h3 class="text-2xl font-bold">${totalHours.toFixed(1)}h</h3></div>
                    <div class="bg-emerald-50/50 p-3 rounded-full text-emerald-600"><i class="fa-solid fa-clock text-lg"></i></div>
                </div>
                <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm flex items-center justify-between">
                    <div><p class="text-xs text-slate-500 mb-1 font-semibold">AI é ä¼°</p><h3 class="text-2xl font-bold">${totalEstHours.toFixed(1)}h</h3></div>
                    <div class="bg-indigo-50/50 p-3 rounded-full text-indigo-600"><i class="fa-solid fa-robot text-lg"></i></div>
                </div>
                <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm flex items-center justify-between">
                    <div>
                        <p class="text-xs text-slate-500 mb-1 font-semibold">é ä¼°åå·®</p>
                        <h3 class="text-2xl font-bold ${varColor}">${totalVariance > 0 ? '+' : ''}${totalVariance.toFixed(1)}h</h3>
                        <p class="text-xs ${varColor} font-bold mt-0.5"><i class="fa-solid ${varIcon} mr-1"></i>${totalVarPct}%</p>
                    </div>
                    <div class="bg-slate-50/50 p-3 rounded-full text-slate-400"><i class="fa-solid fa-scale-balanced text-lg"></i></div>
                </div>
                <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm flex items-center justify-between">
                    <div><p class="text-xs text-slate-500 mb-1 font-semibold">å°ˆæ¡ˆé …ç›®</p><h3 class="text-2xl font-bold">${projects.length}</h3></div>
                    <div class="bg-amber-50/50 p-3 rounded-full text-amber-600"><i class="fa-solid fa-folder-tree text-lg"></i></div>
                </div>
            `;

            // Charts
            if (hoursChartIns) hoursChartIns.destroy();
            if (categoryChartIns) categoryChartIns.destroy();

            const theme = document.documentElement.getAttribute('data-theme') || 'light';
            const isDark = theme !== 'light';
            const textColor = isDark ? '#cbd5e1' : '#475569';
            const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.05)';

            // Bar Chart
            const ctx1 = document.getElementById('hoursChart').getContext('2d');
            hoursChartIns = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: data.map(c => c.title.substring(0, 12) + (c.title.length > 12 ? '...' : '')),
                    datasets: [{
                        label: 'å·¥æ™‚ (å°æ™‚)',
                        data: data.map(c => c.hours),
                        backgroundColor: isDark ? 'rgba(96, 165, 250, 0.4)' : 'rgba(59, 130, 246, 0.6)',
                        borderColor: isDark ? 'rgba(96, 165, 250, 0.8)' : 'rgba(59, 130, 246, 1)',
                        borderWidth: 1,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: gridColor },
                            ticks: { color: textColor }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: textColor }
                        }
                    }
                }
            });

            // Doughnut Chart
            const ctx2 = document.getElementById('categoryChart').getContext('2d');
            categoryChartIns = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(categories),
                    datasets: [{
                        data: Object.values(categories).map(c => c.hours),
                        backgroundColor: ['#ef4444', '#8b5cf6', '#3b82f6', '#22c55e', '#f59e0b'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: textColor,
                                generateLabels: function (chart) {
                                    const data = chart.data;
                                    if (data.labels.length && data.datasets.length) {
                                        const dataset = data.datasets[0];
                                        const total = dataset.data.reduce((acc, val) => acc + val, 0);

                                        return data.labels.map((label, i) => {
                                            const value = dataset.data[i];
                                            const percentage = ((value / total) * 100).toFixed(1) + '%';
                                            return {
                                                text: `${percentage} ${label}`,
                                                fillStyle: dataset.backgroundColor[i],
                                                fontColor: textColor, // Explicitly set text color per item
                                                hidden: isNaN(dataset.data[i]) || chart.getDatasetMeta(0).data[i].hidden,
                                                index: i
                                            };
                                        });
                                    }
                                    return [];
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const value = context.raw;
                                    const total = context.dataset.data.reduce((acc, val) => acc + val, 0);
                                    const percentage = ((value / total) * 100).toFixed(1) + '%';
                                    return `${context.label}: ${value.toFixed(1)}h (${percentage})`;
                                }
                            }
                        }
                    }
                }
            });

            // æ¸²æŸ“é¡åˆ¥åå·®åˆ†ææ¸…å–® (æ©«å‘å„ªåŒ–ç‰ˆ)
            const varianceList = document.getElementById('categoryVarianceList');
            const catColors = {
                'DEBUG': '#ef4444',
                'UI èª¿æ•´': '#8b5cf6',
                'æ¶æ§‹è®Šæ›´': '#3b82f6',
                'çŸ¥è­˜æ”¶é›†': '#22c55e',
                'è³‡æ–™è™•ç†': '#f59e0b',
                'é–‹ç™¼æ¨¡å¼': '#0ea5e9'
            };

            varianceList.innerHTML = `
                <div class="flex justify-between text-xs font-bold text-slate-400 uppercase tracking-wider mb-4 px-2">
                    <span class="w-1/4">é–‹ç™¼é¡åˆ¥</span>
                    <span class="w-2/4 text-center">é ä¼° â” å¯¦éš›</span>
                    <span class="w-1/4 text-right">åå·® (æ¯”ä¾‹)</span>
                </div>
                ${Object.entries(categories)
                    .sort(([, statsA], [, statsB]) => statsB.hours - statsA.hours) // Sort by hours before mapping
                    .map(([name, stats]) => {
                        const diff = stats.hours - stats.estHours;
                        const diffPct = ((diff / (stats.estHours || 1)) * 100).toFixed(0);
                        const varColorClass = diff > 0 ? 'text-rose-500' : 'text-emerald-500';
                        const themeColor = catColors[name] || '#64748b';

                        return `
                        <div class="flex items-center justify-between p-1.5 px-3 rounded-lg bg-slate-50/50 border-l-4 border-slate-200 hover:border-slate-300 transition-all mb-1.5 shadow-sm" style="border-left-color: ${themeColor}">
                            <div class="w-1/4">
                                <span class="text-base font-bold text-slate-700">${name}</span>
                            </div>
                            <div class="w-2/4 flex items-center justify-center gap-6">
                                <span class="text-sm font-mono text-slate-400">${stats.estHours.toFixed(1)}h</span>
                                <i class="fa-solid fa-arrow-right text-xs text-slate-300"></i>
                                <span class="text-sm font-mono font-bold text-slate-800">${stats.hours.toFixed(1)}h</span>
                            </div>
                            <div class="w-1/4 text-right">
                                <span class="text-base font-black ${varColorClass} tracking-tight">
                                    ${diff > 0 ? '+' : ''}${diff.toFixed(1)}h
                                    <span class="text-sm font-bold ml-2">(${diff > 0 ? '+' : ''}${diffPct}%)</span>
                                </span>
                            </div>
                        </div>
                    `;
                    }).join('')}
            `;

            // Detail Table
            document.getElementById('detailTableBody').innerHTML = data.map((c, index) => `
                <tr class="border-b border-slate-100 hover:bg-slate-50">
                    <td class="px-6 py-4 text-slate-400 text-xs">${c._seq}</td>
                    <td class="px-6 py-4 font-medium">${c.title}</td>
                    <td class="px-6 py-4 text-xs text-slate-500">${c.engineer || '-'}</td>
                    <td class="px-6 py-4"><span class="px-3 py-1 rounded-full text-xs whitespace-nowrap ${getCategoryBadge(c.category)}">${c.category}</span></td>
                    <td class="px-6 py-4"><span class="text-emerald-600">âœ“ å·²å®Œæˆ</span></td>
                    <td class="px-6 py-4 text-right font-mono">${c.hours}h</td>
                    <td class="px-6 py-4 text-slate-500 text-xs">${c.summary || '-'}</td>
                </tr>
            `).join('');
        }

        // ====== Report Generation ======
        // ====== Report Generation ======
        function generateReport() {
            const format = document.getElementById('exportFormat').value;
            let output = '';
            const filteredData = getFilteredData();
            const totalHours = filteredData.reduce((s, c) => s + c.hours, 0);

            if (format === 'json') {
                output = JSON.stringify({
                    generatedAt: new Date().toISOString(),
                    summary: {
                        totalConversations: filteredData.length,
                        totalHours: parseFloat(totalHours.toFixed(1))
                    },
                    conversations: filteredData
                }, null, 2);
            } else if (format === 'dashboard') {
                output = '# å°ˆæ¡ˆé€²åº¦è¿½è¹¤\n\n## å­é …ç›®é€²åº¦\n\n';
                output += '| å­é …ç›® | è² è²¬äºº | ç‹€æ…‹ | é€²åº¦ | å¯¦éš›å·¥æ™‚ | é ä¼°å‰©é¤˜ | å•é¡Œ |\n';
                output += '|--------|--------|------|------|----------|----------|------|\n';
                filteredData.forEach(c => {
                    const status = c.category === 'DEBUG' ? 'ğŸŸ¡ å¡é—œ' : 'âœ… å®Œæˆ';
                    output += `| ${c.title} | AI åŠ©ç† | ${status} | 100% | ${c.hours}h | 0h | ${c.category === 'DEBUG' ? c.summary.substring(0, 20) : 'ç„¡'} |\n`;
                });
            } else {
                output = `# å°ˆæ¡ˆäº’å‹•æ­·å²å ±å‘Š\n\n`;
                output += `> **è‡ªå‹•ç”¢ç”Ÿæ–¼**: ${new Date().toLocaleString('zh-TW')}\n`;

                const projFilter = document.getElementById('filterProject').value;
                const startStr = document.getElementById('filterStart').value;
                const endStr = document.getElementById('filterEnd').value;
                output += `> **ç¯©é¸å°ˆæ¡ˆ**: ${projFilter || 'å…¨éƒ¨'}\n`;
                output += `> **æ—¥æœŸç¯„åœ**: ${startStr || 'æœªè¨­'} ~ ${endStr || 'æœªè¨­'}\n\n`;

                output += `---\n\n## ğŸ“Š çµ±è¨ˆç¸½è¦½\n\n`;
                output += `| æŒ‡æ¨™ | æ•¸å€¼ |\n|------|------|\n`;
                output += `| å°è©±ç¸½æ•¸ | ${filteredData.length} å€‹ |\n`;
                output += `| ç¸½å·¥æ™‚ | ${totalHours.toFixed(1)} å°æ™‚ |\n\n`;

                // Add Staff Stats Table if selected
                if (document.getElementById('includeStaffStats').checked) {
                    const engMap = {};
                    filteredData.forEach(c => {
                        const name = c.engineer || 'æœªæŒ‡å®š';
                        if (!engMap[name]) engMap[name] = 0;
                        engMap[name] += c.hours;
                    });

                    output += `## ğŸ‘¥ äººå“¡æ™‚æ•¸çµ±è¨ˆè¡¨\n\n`;
                    output += `| äººå“¡ | ç¸½è¨ˆå·¥æ™‚ | ä½”æ¯” |\n|------|----------|------|\n`;
                    Object.entries(engMap).sort((a, b) => b[1] - a[1]).forEach(([name, hours]) => {
                        const pct = ((hours / (totalHours || 1)) * 100).toFixed(1) + '%';
                        output += `| ${name} | ${hours.toFixed(1)}h | ${pct} |\n`;
                    });
                    output += `\n`;
                }

                // Add Daily Stats Table if selected
                if (document.getElementById('includeDailyStats').checked) {
                    const engineers = [...new Set(filteredData.filter(c => c.engineer).map(c => c.engineer))].sort();
                    const dailyData = {};
                    // å¯¦ä½œèˆ‡ UI ä¸€è‡´çš„è·¨æ—¥æ‹†åˆ†æ¼”ç®—æ³•
                    filteredData.forEach(c => {
                        const eng = c.engineer || 'æœªæŒ‡å®š';
                        const startTime = new Date(c.createdTime);
                        const endTime = new Date(c.modifiedTime);
                        const totalHours = c.hours || 0;

                        if (endTime <= startTime || isNaN(startTime.getTime())) {
                            const date = endTime.toLocaleDateString('zh-TW');
                            if (!dailyData[date]) dailyData[date] = {};
                            if (!dailyData[date][eng]) dailyData[date][eng] = 0;
                            dailyData[date][eng] += totalHours;
                            return;
                        }

                        let tempStart = new Date(startTime);
                        const totalSpanMs = endTime - startTime;

                        while (tempStart < endTime) {
                            const nextDay = new Date(tempStart);
                            nextDay.setHours(24, 0, 0, 0);
                            const endOfSegment = nextDay < endTime ? nextDay : endTime;
                            const segmentRatio = (endOfSegment - tempStart) / totalSpanMs;
                            const segmentHours = totalHours * segmentRatio;

                            const dateStr = tempStart.toLocaleDateString('zh-TW');
                            if (!dailyData[dateStr]) dailyData[dateStr] = {};
                            if (!dailyData[dateStr][eng]) dailyData[dateStr][eng] = 0;
                            dailyData[dateStr][eng] += segmentHours;
                            tempStart = nextDay;
                        }
                    });

                    // Sort dates ascending as requested (from small to large)
                    const dates = Object.keys(dailyData).sort((a, b) => new Date(a) - new Date(b));

                    output += `## ğŸ“… äººå“¡æ¯æ—¥å·¥æ™‚çµ±è¨ˆ\n\n`;
                    output += `| æ—¥æœŸ | ${engineers.join(' | ')} | ç•¶æ—¥ç¸½è¨ˆ |\n`;
                    output += `|------|${engineers.map(() => '---|').join('')}---|\n`;

                    dates.forEach(date => {
                        const row = engineers.map(eng => (dailyData[date][eng] || 0).toFixed(1) + 'h');
                        const dayTotal = engineers.reduce((s, eng) => s + (dailyData[date][eng] || 0), 0);
                        output += `| ${date} | ${row.join(' | ')} | **${dayTotal.toFixed(1)}h** |\n`;
                    });
                    output += `\n`;
                }

                output += `---\n\n## ğŸ“‹ è©³ç´°è¨˜éŒ„\n\n`;
                filteredData.forEach((c, i) => {
                    output += `### ${i + 1}. ${c.title}\n`;
                    output += `- **å°ˆæ¡ˆ**: ${c.project}\n`;
                    output += `- **é¡åˆ¥**: ${c.category}\n`;
                    output += `- **äººå“¡**: ${c.engineer || '-'}\n`;
                    output += `- **å·¥æ™‚**: ${c.hours} å°æ™‚\n`;
                    output += `- **æ‘˜è¦**: ${c.summary || 'ç„¡'}\n\n`;
                });
            }

            document.getElementById('reportPreview').textContent = output;
        }

        function copyReport() {
            navigator.clipboard.writeText(document.getElementById('reportPreview').textContent);
            alert('âœ… å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
        }

        function downloadReport() {
            const format = document.getElementById('exportFormat').value;
            const content = document.getElementById('reportPreview').textContent;
            const ext = format === 'json' ? '.json' : '.md';
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `project_interaction_history${ext}`;
            a.click();
        }

        // ====== Project History Generation ======
        const PROJECT_META = {
            'ç¦è‡³å¿ƒéˆç±¤': {
                type: 'React + TypeScript ç¶²é æ‡‰ç”¨ç¨‹å¼',
                description: 'æ•¸ä½æ±‚ç±¤ç³»çµ±ï¼Œæ•´åˆ AI è§£ç±¤ã€æœ¬åœ°å„²å­˜ã€é›²ç«¯åŒæ­¥ã€PDF ç”Ÿæˆç­‰åŠŸèƒ½'
            },
            'AIå°ˆæ¡ˆç®¡ç†': {
                type: 'Markdown æ–‡æª”èˆ‡ HTML å·¥å…·é›†',
                description: 'Gemini é©…å‹•é–‹ç™¼æ–¹æ³•è«– (GDDM) èˆ‡ä¸­å¿ƒç¨‹å¼é–‹ç™¼æ–¹æ³• (CPDM) çš„å®Œæ•´é«”ç³»'
            },
            'Antigravity': {
                type: 'AI å”ä½œé–‹ç™¼',
                description: 'Antigravity ä»£ç†äººè‡ªæˆ‘è¿­ä»£èˆ‡ç³»çµ±ç¶­è­·'
            }
        };

        function generateProjectHistory() {
            const projectName = document.getElementById('historyProjectSelect').value;
            if (!projectName) {
                alert('è«‹å…ˆé¸æ“‡ä¸€å€‹å°ˆæ¡ˆï¼');
                return;
            }

            // Filter data for this project
            const projectData = currentData.filter(c => c.project === projectName);
            if (projectData.length === 0) {
                alert(`æ‰¾ä¸åˆ° "${projectName}" çš„å°è©±è¨˜éŒ„ï¼Œè«‹å…ˆè¼‰å…¥æ•¸æ“šï¼`);
                return;
            }

            // Sort by time
            projectData.sort((a, b) => new Date(a.modifiedTime) - new Date(b.modifiedTime));

            const meta = PROJECT_META[projectName] || { type: 'æœªçŸ¥', description: '' };
            const totalHours = projectData.reduce((s, c) => s + c.hours, 0);
            const firstDate = new Date(projectData[0].modifiedTime);
            const lastDate = new Date(projectData[projectData.length - 1].modifiedTime);
            const daySpan = Math.ceil((lastDate - firstDate) / (1000 * 60 * 60 * 24)) + 1;

            // Category stats
            const categories = {};
            projectData.forEach(c => {
                if (!categories[c.category]) categories[c.category] = [];
                categories[c.category].push(c);
            });

            // Build output
            let out = '';
            out += `# ${projectName}å°ˆæ¡ˆé–‹ç™¼äº’å‹•æ­·å²æ¸…å–®\n\n`;
            out += `## å°ˆæ¡ˆæ¦‚è¿°\n`;
            out += `**å°ˆæ¡ˆåç¨±**: ${projectName}  \n`;
            out += `**å°ˆæ¡ˆé¡å‹**: ${meta.type}  \n`;
            out += `**ä¸»è¦åŠŸèƒ½**: ${meta.description}\n\n`;
            out += `---\n\n`;

            out += `## äº’å‹•æ­·å²çµ±è¨ˆ\n\n`;
            out += `### ç¸½è¨ˆ\n`;
            out += `- **å°è©±æ•¸é‡**: ${projectData.length} å€‹ä¸»è¦å°è©±\n`;
            out += `- **é–‹ç™¼æ™‚é–“è·¨åº¦**: ${firstDate.toLocaleDateString('zh-TW')} è‡³ ${lastDate.toLocaleDateString('zh-TW')} (ç´„ ${daySpan} å¤©)\n`;
            out += `- **å¯¦éš›é–‹ç™¼æ™‚é–“**: ç´„ ${totalHours.toFixed(1)} å°æ™‚\n\n`;
            out += `---\n\n`;

            out += `## è©³ç´°äº’å‹•è¨˜éŒ„\n\n`;
            const numEmoji = ['1ï¸âƒ£', '2ï¸âƒ£', '3ï¸âƒ£', '4ï¸âƒ£', '5ï¸âƒ£', '6ï¸âƒ£', '7ï¸âƒ£', '8ï¸âƒ£', '9ï¸âƒ£', 'ğŸ”Ÿ'];

            projectData.forEach((c, i) => {
                const emoji = numEmoji[i] || `${i + 1}.`;
                const modTime = new Date(c.modifiedTime);

                out += `### ${emoji} ${c.title}\n`;
                out += `**å°è©± ID**: ${c.id}  \n`;
                out += `**å®Œæˆæ™‚é–“**: ${modTime.toLocaleString('zh-TW')}  \n`;
                out += `**å¯¦éš›å·¥ä½œæ™‚é–“**: ç´„ ${c.hours} å°æ™‚\n\n`;

                out += `#### å•é¡Œæè¿°\n`;
                out += `- ${c.summary}\n\n`;

                out += `#### è§£æ±ºæ–¹æ¡ˆ\n\n`;
                out += `**AI æå‡ºçš„æ–¹æ¡ˆ**:\n`;
                out += `- âœ… åˆ†æå•é¡Œä¸¦æä¾›è§£æ±ºæ–¹æ¡ˆ\n`;
                out += `- âœ… å¯¦ä½œç¨‹å¼ç¢¼æˆ–æ–‡æª”\n`;
                out += `- âœ… é©—è­‰èˆ‡æ¸¬è©¦\n\n`;

                out += `**ä½¿ç”¨è€…æå‡ºçš„æ–¹æ¡ˆ**:\n`;
                out += `- âœ… æä¾›éœ€æ±‚æè¿°\n`;
                out += `- âœ… ç¢ºèªé©—æ”¶æ¨™æº–\n\n`;

                out += `#### æŠ€è¡“é¡åˆ¥\n`;
                const catEmoji = {
                    'DEBUG': 'ğŸ› **ç¨‹å¼ DEBUG**',
                    'UI èª¿æ•´': 'ğŸ¨ **UI èª¿æ•´**',
                    'æ¶æ§‹è®Šæ›´': 'ğŸ—ï¸ **æ¶æ§‹è®Šæ›´**',
                    'çŸ¥è­˜æ”¶é›†': 'ğŸ“š **çŸ¥è­˜æ”¶é›†**',
                    'è³‡æ–™è™•ç†': 'ğŸ’¾ **è³‡æ–™è™•ç†**',
                    'é–‹ç™¼æ¨¡å¼': 'âš¡ **é–‹ç™¼æ¨¡å¼**'
                };
                out += `- ${catEmoji[c.category] || c.category}: ${c.summary}\n\n`;
                out += `---\n\n`;
            });

            // Statistics Summary
            out += `## çµ±è¨ˆåˆ†æ\n\n`;
            out += `### æŒ‰é¡åˆ¥çµ±è¨ˆ\n\n`;
            for (const [cat, items] of Object.entries(categories)) {
                const catEmoji = {
                    'DEBUG': 'ğŸ›',
                    'UI èª¿æ•´': 'ğŸ¨',
                    'æ¶æ§‹è®Šæ›´': 'ğŸ—ï¸',
                    'çŸ¥è­˜æ”¶é›†': 'ğŸ“š',
                    'è³‡æ–™è™•ç†': 'ğŸ’¾',
                    'é–‹ç™¼æ¨¡å¼': 'âš¡'
                };
                const hours = items.reduce((s, c) => s + c.hours, 0);
                out += `#### ${catEmoji[cat] || 'ğŸ“Œ'} ${cat} (${items.length} é …, ${hours.toFixed(1)} å°æ™‚)\n`;
                items.forEach((c, j) => out += `${j + 1}. ${c.title}\n`);
                out += `\n`;
            }

            out += `---\n\n`;
            out += `## çµè«–\n\n`;
            out += `æœ¬å°ˆæ¡ˆåœ¨ç´„ **${daySpan} å¤©çš„é–‹ç™¼æ™‚é–“**å…§ï¼Œé€é **${projectData.length} å€‹ä¸»è¦å°è©±**ï¼Œå®Œæˆäº†å¾éœ€æ±‚åˆ°å¯¦ç¾çš„å®Œæ•´é–‹ç™¼ã€‚\n`;
            out += `**ç¸½æŠ•å…¥å·¥æ™‚**: ${totalHours.toFixed(1)} å°æ™‚\n\n`;
            out += `---\n\n`;
            out += `*æ­¤å ±å‘Šç”± CPDM å°ˆæ¡ˆäº’å‹•æ­·å²ç”¢ç”Ÿå™¨è‡ªå‹•ç”Ÿæˆæ–¼ ${new Date().toLocaleString('zh-TW')}*\n`;

            document.getElementById('historyPreview').textContent = out;
        }

        function copyProjectHistory() {
            navigator.clipboard.writeText(document.getElementById('historyPreview').textContent);
            alert('âœ… å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
        }

        function downloadProjectHistory() {
            const projectName = document.getElementById('historyProjectSelect').value || 'project';
            const content = document.getElementById('historyPreview').textContent;
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `${projectName}_interaction_history.md`;
            a.click();
        }

        // ====== Model Usage Countdown ======
        let countdownSeconds = 0;
        function updateUsageCountdown() {
            if (countdownSeconds <= 0) return;
            const h = Math.floor(countdownSeconds / 3600);
            const m = Math.floor((countdownSeconds % 3600) / 60);
            const s = countdownSeconds % 60;
            const timerStr = [h, m, s].map(v => v.toString().padStart(2, '0')).join(':');
            const el = document.getElementById('usageCountdown');
            if (el) el.textContent = timerStr;
            countdownSeconds--;
        }
        setInterval(updateUsageCountdown, 1000);

        function uploadUsageFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = event => {
                    try {
                        const data = JSON.parse(event.target.result);
                        renderUsage(data);
                    } catch (err) {
                        alert('JSON æ ¼å¼éŒ¯èª¤');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function renderUsage(data) {
            const container = document.getElementById('modelUsageList');
            container.innerHTML = '';

            if (data.usage && data.usage.length > 0) {
                data.usage.forEach(item => {
                    const div = document.createElement('div');
                    const colorClass = item.model.includes('pro') ? 'from-amber-500 to-orange-400' : 'from-indigo-500 to-blue-400';
                    div.innerHTML = `
                        <div class="flex justify-between text-xs mb-1.5">
                            <span class="font-semibold text-slate-700">${item.model}</span>
                            <span class="text-slate-500">${item.used} / ${item.limit} <span class="text-slate-300 ml-1">| ${item.percent}%</span></span>
                        </div>
                        <div class="w-full bg-slate-100 rounded-full h-2 overflow-hidden">
                            <div class="bg-gradient-to-r ${colorClass} h-full rounded-full transition-all duration-1000" style="width: ${item.percent}%"></div>
                        </div>
                    `;
                    container.appendChild(div);
                });

                if (data.resetCountdownMs) {
                    countdownSeconds = Math.floor(data.resetCountdownMs / 1000);
                }
            } else {
                container.innerHTML = '<p class="text-xs text-slate-500 text-center py-4">ç„¡ä»Šæ—¥ä½¿ç”¨ç´€éŒ„</p>';
            }
        }

        // å­—é«”å¤§å°æ§åˆ¶
        function updateFontSize(size) {
            document.documentElement.style.fontSize = size + 'px';
            document.getElementById('fontSizeValue').textContent = size + 'px';
            localStorage.setItem('dashboard-font-size', size);
        }

        // ä¸»é¡Œåˆ‡æ›
        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('dashboard-theme', theme);

            // å…¨åŸŸåœ–è¡¨å­—é«”é¡è‰²æ›´æ–°
            const isDark = theme !== 'light';
            Chart.defaults.color = isDark ? '#cbd5e1' : '#475569';

            // æ›´æ–°æŒ‰éˆ•æ¨£å¼
            ['light', 'slate', 'dark'].forEach(t => {
                const btn = document.getElementById(`theme-btn-${t}`);
                if (btn) {
                    if (t === theme) {
                        btn.classList.add('bg-white', 'shadow-sm', 'ring-1', 'ring-slate-200');
                        btn.classList.remove('opacity-50');
                    } else {
                        btn.classList.remove('bg-white', 'shadow-sm', 'ring-1', 'ring-slate-200');
                        btn.classList.add('opacity-50');
                    }
                }
            });

            // é‡æ–°æ¸²æŸ“åœ–è¡¨ä»¥é©æ‡‰é¡è‰² (å¦‚æœå·²ç¶“è¼‰å…¥æ•¸æ“š)
            if (currentData.length > 0) {
                renderDashboard(getFilteredData());
            }
        }

        // åˆå§‹åŒ–
        function initDashboard() {
            // è¨­å®šæ—¥æœŸåˆå§‹å€¼
            document.getElementById('filterStart').value = '2025-12-17';
            const now = new Date();
            const localDate = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');
            document.getElementById('filterEnd').value = localDate;

            // æ¢å¾©å­—é«”å¤§å°
            const savedSize = localStorage.getItem('dashboard-font-size') || '16';
            document.getElementById('fontSizeSlider').value = savedSize;
            updateFontSize(savedSize);

            // æ¢å¾©ä¸»é¡Œ
            const savedTheme = localStorage.getItem('dashboard-theme') || 'light';
            setTheme(savedTheme);

            const loadingOverlay = showLoading('åˆå§‹åŒ–ä¸­...');
            setTimeout(() => {
                hideLoading(loadingOverlay);
            }, 500);
        }

        // Initialize when page loads
        initDashboard();
    </script>
</body>

</html>